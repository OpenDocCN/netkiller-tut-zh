# 部分 V. MongoDB

http://www.mongodb.org/

## 第 42 章 Install 安装 MongoDB

## Quickstart

### 二进制 tar 包安装

Install MongoDB

```
wget http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-1.5.5.tgz

debian:/srv# tar zxf mongodb-linux-x86_64-1.5.5.tgz
debian:/srv# ln -s mongodb-linux-x86_64-1.5.5 mongodb

```

Create a data directory

By default MongoDB will store data in /data/db, but it won't automatically create that directory. To create it, do:

```
$ sudo mkdir -p /data/db/
$ sudo chown `id -u` /data/db

```

You can also tell MongoDB to use a different data directory, with the --dbpath option.

Run and connect to the server

First, start the MongoDB server in one terminal:

```
$ ./mongodb/bin/mongod

```

In a separate terminal, start the shell, which will connect to localhost by default:

```
$ ./mongodb/bin/mongo
> db.foo.save( { a : 1 } )
> db.foo.find()

```

Congratulations, you've just saved and retrieved your first document with MongoDB!

例 42.1. MongoDB Test

```

debian:/srv/mongodb/bin# ./mongo
MongoDB shell version: 1.5.5
connecting to: test
[initandlisten] Thu Jul 22 16:42:07 connection accepted from 127.0.0.1:42876 #1
> db.foo.save({a:1})
Thu Jul 22 16:42:23 allocating new datafile /data/db/test.ns, filling with zeroes...
Thu Jul 22 16:42:23 done allocating datafile /data/db/test.ns, size: 16MB,  took 0.025 secs
Thu Jul 22 16:42:23 allocating new datafile /data/db/test.0, filling with zeroes...
Thu Jul 22 16:42:23 done allocating datafile /data/db/test.0, size: 64MB,  took 0.105 secs
[conn1] Thu Jul 22 16:42:23 building new index on { _id: 1 } for test.foo
[conn1] Thu Jul 22 16:42:23 Buildindex test.foo idxNo:0 { name: "_id_", ns: "test.foo", key: { _id: 1 } }
[conn1] Thu Jul 22 16:42:23 done for 0 records 0secs
[conn1] Thu Jul 22 16:42:23 insert test.foo 136ms
> Thu Jul 22 16:42:23 allocating new datafile /data/db/test.1, filling with zeroes...
Thu Jul 22 16:42:24 done allocating datafile /data/db/test.1, size: 128MB,  took 0.228 secs
> db.foo.find()
{ "_id" : ObjectId("4c48046f74050cbf6c9a0ef6"), "a" : 1 }

> use neo
switched to db neo
> db.foo.save({a:1})
Thu Jul 22 16:54:50 allocating new datafile /data/db/neo.ns, filling with zeroes...
Thu Jul 22 16:54:50 done allocating datafile /data/db/neo.ns, size: 16MB,  took 0.026 secs
Thu Jul 22 16:54:50 allocating new datafile /data/db/neo.0, filling with zeroes...
Thu Jul 22 16:54:50 done allocating datafile /data/db/neo.0, size: 64MB,  took 0.122 secs
[conn1] Thu Jul 22 16:54:50 building new index on { _id: 1 } for neo.foo
[conn1] Thu Jul 22 16:54:50 Buildindex neo.foo idxNo:0 { name: "_id_", ns: "neo.foo", key: { _id: 1 } }
Thu Jul 22 16:54:50 allocating new datafile /data/db/neo.1, filling with zeroes...
[conn1] Thu Jul 22 16:54:50 done for 0 records 0.01secs
[conn1] Thu Jul 22 16:54:50 insert neo.foo 164ms
> Thu Jul 22 16:54:50 done allocating datafile /data/db/neo.1, size: 128MB,  took 0.217 secs

> db.foo.find()
{ "_id" : ObjectId("4c48075a74050cbf6c9a0ef7"), "a" : 1 }
>

> db.neo.save({a:1})
[conn1] Thu Jul 22 16:58:32 building new index on { _id: 1 } for neo.neo
[conn1] Thu Jul 22 16:58:32 Buildindex neo.neo idxNo:0 { name: "_id_", ns: "neo.neo", key: { _id: 1 } }
[conn1] Thu Jul 22 16:58:32 done for 0 records 0.024secs
> db.neo.find()
{ "_id" : ObjectId("4c48083874050cbf6c9a0ef8"), "a" : 1 }

```

Starting Mongo

Running as a Daemon

```
 $ ./mongod --fork --logpath /var/log/mongodb.log --logappend

```

### Ubuntu MongoDB

```
$ sudo apt-get install mongodb-server mongodb-clients

```

```
$ /etc/init.d/mongodb
Usage: /etc/init.d/mongodb {start|stop|force-stop|restart|force-reload|status}

```

### CentOS MongoDB

CentOS 默认 MongoDB 是 2.6.12

```
[root@iZ623h9icu8Z ~]# yum info mongodb
Loaded plugins: langpacks
Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast
Available Packages
Name        : mongodb
Arch        : x86_64
Version     : 2.6.12
Release     : 3.el7
Size        : 43 M
Repo        : epel/x86_64
Summary     : High-performance, schema-free document-oriented database
URL         : http://www.mongodb.org
License     : AGPLv3 and zlib and ASL 2.0
Description : Mongo (from "humongous") is a high-performance, open source, schema-free
            : document-oriented database. MongoDB is written in C++ and offers the following
            : features:
            :     * Collection oriented storage: easy storage of object/JSON-style data
            :     * Dynamic queries
            :     * Full index support, including on inner objects and embedded arrays
            :     * Query profiling
            :     * Replication and fail-over support
            :     * Efficient storage of binary data including large objects (e.g. photos
            :     and videos)
            :     * Auto-sharding for cloud-level scalability (currently in early alpha)
            :     * Commercial Support Available
            : 
            : A key goal of MongoDB is to bridge the gap between key/value stores (which are
            : fast and highly scalable) and traditional RDBMS systems (which are deep in
            : functionality).

```

```
# yum install mongodb-server

# chkconfig mongod on

# service mongod start

```

单独安装客户端

```
# yum install mongodb

```

### 从官网安装最新版本的 MongoDB 3.4

官网的 rpm 包是如下

```
[root@netkiller ~]# yum search mongodb | grep "\-org"
mongodb-org.x86_64 : MongoDB open source document-oriented database system
mongodb-org-mongos.x86_64 : MongoDB sharded cluster query router
mongodb-org-server.x86_64 : MongoDB database server
mongodb-org-shell.x86_64 : MongoDB shell client
mongodb-org-tools.x86_64 : MongoDB tools			

```

```

#!/bin/sh
cat << 'EOF' >> /etc/yum.repos.d/mongodb-org-3.4.repo
[mongodb-org-3.4]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.4/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-3.4.asc
EOF

```

#### Server

```

yum install -y mongodb-org-server

cp /etc/mongod.conf{,.original}

systemctl is-enabled mongod
systemctl start mongod

```

#### Client

```
yum install -y mongodb-org-shell				

```

```

[root@netkiller ~]# mongo

MongoDB shell version v3.4.0
connecting to: mongodb://127.0.0.1:27017
MongoDB server version: 3.4.0
Welcome to the MongoDB shell.
For interactive help, type "help".
For more comprehensive documentation, see
	http://docs.mongodb.org/
Questions? Try the support group
	http://groups.google.com/group/mongodb-user
Server has startup warnings: 
2016-11-30T11:34:36.493+0800 I STORAGE  [initandlisten] 
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] 
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] 
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] 
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is 'always'.
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] 
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is 'always'.
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2016-11-30T11:34:36.560+0800 I CONTROL  [initandlisten] 
> show dbs
admin  0.000GB
local  0.000GB
> exit
bye

```

#### 工具

```
# yum install mongodb-org-tools

# rpm -ql mongodb-org-tools.x86_64 0:3.4.1-1.el7
/usr/bin/bsondump
/usr/bin/mongodump
/usr/bin/mongoexport
/usr/bin/mongofiles
/usr/bin/mongoimport
/usr/bin/mongooplog
/usr/bin/mongoperf
/usr/bin/mongorestore
/usr/bin/mongostat
/usr/bin/mongotop
/usr/share/man/man1/bsondump.1
/usr/share/man/man1/mongodump.1
/usr/share/man/man1/mongoexport.1
/usr/share/man/man1/mongofiles.1
/usr/share/man/man1/mongoimport.1
/usr/share/man/man1/mongooplog.1
/usr/share/man/man1/mongoperf.1
/usr/share/man/man1/mongorestore.1
/usr/share/man/man1/mongostat.1
/usr/share/man/man1/mongotop.1

```

### MongoDB + Hadoop

Hadoop Connector

http://docs.mongodb.org/ecosystem/tutorial/getting-started-with-hadoop/

```
git clone https://github.com/mongodb/mongo-hadoop.git
git checkout release-1.0

```

```
# vim build.sbt
hadoopRelease in ThisBuild := "cdh4"

```

```
./sbt package

```

```

wget --no-check-certificate https://github.com/downloads/mongodb/mongo-java-driver/mongo-2.7.3.jar
cp mongo-2.7.3.jar /usr/lib/hadoop/lib/
cp core/target/mongo-hadoop-core_cdh3u3-1.0.0.jar /usr/lib/hadoop/lib/

```

待续......

## OSCM 一键安装 MongoDB 4.0.2

安装 MongoDB

```

curl -s https://raw.githubusercontent.com/oscm/shell/master/database/mongodb/mongodb.org/mongodb-4.0.2.sh | bash

```

创建管理和数据库用户

```

# mongo

use admin;
db.createUser(
   {
     user: "admin",
     pwd: "chen",
     roles: [ "dbAdmin", "dbOwner", "userAdmin" ]
   }
);

use products
db.createUser(
   {
     user: "accountUser",
     pwd: "password",
     roles: [ "readWrite", "dbAdmin" ]
   }
)

```

开启认证

```

curl -s https://raw.githubusercontent.com/oscm/shell/master/database/mongodb/mongodb.org/security.authorization.enabled.sh | bash		

```

## Replication

很多教程上面采用手工配置主从复制，我不建议你这样启动，请采用修改/etc/mongod.conf 配置文件的方案。

```
创建主：

mongod –port 27017 –dbpath /var/lib/mongodb –master

 创建从：

mongod –port 27017 –dbpath /var/lib/mongodb –slave –source master_ip_address:27017

```

### Master

```
sed -i "s/#master = true/master = true/" /etc/mongod.conf

systemctl restart  mongod

```

### Slave

```
sed -i "s/#slave = true/slave = true/" /etc/mongod.conf
sed -i "s/#source = arg/source = mongodb.master.example.com/" /etc/mongod.conf

systemctl restart  mongod

```

### 测试

进入 Master

```

[root@localhost ~]# mongo
MongoDB shell version: 2.6.11
connecting to: test
Welcome to the MongoDB shell.
For interactive help, type "help".
For more comprehensive documentation, see
	http://docs.mongodb.org/
Questions? Try the support group
	http://groups.google.com/group/mongodb-user
Server has startup warnings:
2015-11-14T15:51:21.215+0800 [initandlisten]
2015-11-14T15:51:21.215+0800 [initandlisten] ** WARNING: Readahead for /var/lib/mongodb is set to 4096KB
2015-11-14T15:51:21.215+0800 [initandlisten] **          We suggest setting it to 256KB (512 sectors) or less
2015-11-14T15:51:21.215+0800 [initandlisten] **          http://dochub.mongodb.org/core/readahead
>
>
> db.foo.save({'name':'neo','address':{'city':'shenzhen','post':518000},'phone':[13113668890,13322993040]})
WriteResult({ "nInserted" : 1 })
> db.foo.find();
{ "_id" : ObjectId("5646e881a11081d5998bf70c"), "name" : "neo", "address" : { "city" : "shenzhen", "post" : 518000 }, "phone" : [ 13113668890, 13322993040 ] }
>

```

进入 Slave

```

[root@localhost ~]# mongo
MongoDB shell version: 2.6.11
connecting to: test
Welcome to the MongoDB shell.
For interactive help, type "help".
For more comprehensive documentation, see
	http://docs.mongodb.org/
Questions? Try the support group
	http://groups.google.com/group/mongodb-user
Server has startup warnings:
2015-11-14T15:51:23.668+0800 [initandlisten]
2015-11-14T15:51:23.668+0800 [initandlisten] ** WARNING: Readahead for /var/lib/mongodb is set to 4096KB
2015-11-14T15:51:23.668+0800 [initandlisten] **          We suggest setting it to 256KB (512 sectors) or less
2015-11-14T15:51:23.668+0800 [initandlisten] **          http://dochub.mongodb.org/core/readahead
> db.foo.find();
{ "_id" : ObjectId("5646e881a11081d5998bf70c"), "name" : "neo", "address" : { "city" : "shenzhen", "post" : 518000 }, "phone" : [ 13113668890, 13322993040 ] }
>

```

## Drivers

### Using MongoDB in PHP

Installing the PHP Driver

```
sudo pecl install mongo

```

Open your php.ini file and add to it:

```
extension=mongo.so

```

例 42.2. Using MongoDB in PHP

```

[root@subversion html]# cat mongo.php
<?php

// connect
$m = new Mongo('192.168.3.9');

// select a database
$db = $m->comedy;
$collection = $db->cartoons;

// add an element
$obj = array( "title" => "Calvin and Hobbes", "author" => "Bill Watterson" );
$collection->insert($obj);

// add another element, with a different "shape"
$obj = array( "title" => "XKCD", "online" => true );
$collection->insert($obj);

// find everything in the collection
$cursor = $collection->find();

// iterate through the results
foreach ($cursor as $obj) {
    echo $obj["title"] . "\n";
}

// disconnect
$m->close();

?>

```

```
[root@subversion html]# php mongo.php
Calvin and Hobbes
XKCD
[root@subversion html]# php mongo.php
Calvin and Hobbes
XKCD
Calvin and Hobbes
XKCD

```

```

> use comedy
switched to db comedy
> db.foo.find()
> db.cartoons.find()
{ "_id" : ObjectId("4c481d2b9503c17611000000"), "title" : "Calvin and Hobbes", "author" : "Bill Watterson" }
{ "_id" : ObjectId("4c481d2b9503c17611010000"), "title" : "XKCD", "online" : true }
{ "_id" : ObjectId("4c481d2f9503c17711000000"), "title" : "Calvin and Hobbes", "author" : "Bill Watterson" }
{ "_id" : ObjectId("4c481d2f9503c17711010000"), "title" : "XKCD", "online" : true }
>

```

## 第 43 章 数据库管理

## lsnrctl

```
启动监听服务：
lsnrctl start

停止监听服务：
lsnrctl stop

查看监听状态：
lsnrctl status

```

## listener.ora

```

[root@database ~]# cat /u01/app/oracle/product/10.2.0.1/network/admin/listener.ora
# listener.ora Network Configuration File: /u01/app/oracle/product/10.2.0.1/network/admin/listener.ora
# Generated by Oracle configuration tools.

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
      (SID_NAME = PLSExtProc)
      (ORACLE_HOME = /u01/app/oracle/product/10.2.0.1)
      (PROGRAM = extproc)
    )
  )

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1))
      (ADDRESS = (PROTOCOL = TCP)(HOST = database.example.com)(PORT = 1521))
    )
  )		

```

## TNS 配置

tnsnames.ora 文件默认在 network/admin/tnsnames.ora

有些情况如你没有权限修改 network/admin/tnsnames.ora, 你可以在$HOME 下创建一个.tnsnames.ora 文件

```

[oracle@orcl admin]$ cat tnsnames.ora
# tnsnames.ora Network Configuration File: /opt/oracle/product/11.2.0/dbhome_1/network/admin/tnsnames.ora
# Generated by Oracle configuration tools.

ORCL =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = oral.example.com)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcl.example.com)
    )
  )

```

测试 TNS

```
$ sqlplus sys/chen@orcl

```

### HOST

HOST 可以使用 IP 地址 HOST = 192.168.0.5 建议改为 hostname 例如 HOST = oral.example.com 这样方便服务器更换 IP。

```
ORCL =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = 192.168.0.5)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SERVICE_NAME = orcl.example.com)
    )
  )

```

SERVICE_NAME 通過 show parameter service_name;查詢

```
$ sqlplus user@orcl

```

### SID

Oracle 10G 之前多采用 SID = oradb

10G 之后更多使用 SERVICE_NAME = orcl.example.com

```

oradb10g =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = db1.domain.com)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SID = oradb10g)
    )
  )

oradb =
  (DESCRIPTION =
    (ADDRESS_LIST =
      (ADDRESS = (PROTOCOL = TCP)(HOST = db2.domain.com)(PORT = 1521))
    )
    (CONNECT_DATA =
      (SID = oradb)
    )
  )	

```

## parameter

### db

```

SQL> show parameter db;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_16k_cache_size                    big integer 0
db_2k_cache_size                     big integer 0
db_32k_cache_size                    big integer 0
db_4k_cache_size                     big integer 0
db_8k_cache_size                     big integer 0
db_block_buffers                     integer     0
db_block_checking                    string      FALSE
db_block_checksum                    string      TYPICAL
db_block_size                        integer     8192
db_cache_advice                      string      ON
db_cache_size                        big integer 0

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_create_file_dest                  string
db_create_online_log_dest_1          string
db_create_online_log_dest_2          string
db_create_online_log_dest_3          string
db_create_online_log_dest_4          string
db_create_online_log_dest_5          string
db_domain                            string      example.com
db_file_multiblock_read_count        integer     128
db_file_name_convert                 string
db_files                             integer     200
db_flash_cache_file                  string

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_flash_cache_size                  big integer 0
db_flashback_retention_target        integer     1440
db_keep_cache_size                   big integer 0
db_lost_write_protect                string      NONE
db_name                              string      orcl
db_recovery_file_dest                string      /opt/oracle/flash_recovery_are
                                                 a
db_recovery_file_dest_size           big integer 3882M
db_recycle_cache_size                big integer 0
db_securefile                        string      PERMITTED
db_ultra_safe                        string      OFF

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_unique_name                       string      orcl
db_writer_processes                  integer     1
dbwr_io_slaves                       integer     0
rdbms_server_dn                      string
standby_archive_dest                 string      ?/dbs/arch
standby_file_management              string      MANUAL
xml_db_events                        string      enable

```

### instance_name

```

SQL> show parameter instance_name;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
instance_name                        string      orcl
SQL>

SQL> select instance from v$thread;

INSTANCE
--------------------------------------------------------------------------------
orcl

```

### service_name

```

SQL> show parameter service_name;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
service_names                        string      orcl.example.com
SQL>

```

### global_name

```

SQL> select * from global_name;

GLOBAL_NAME
--------------------------------------------------------------------------------
ORCL.EXAMPLE.COM

```

### db_name

```

SQL> show parameter db_name;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_name                              string      orcl

SQL> select name from v$database;

NAME
---------
ORCL

```

### db_domain

```

SQL> show parameter db_domain;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_domain                            string      example.com
SQL>

```

### sga

```

SQL> show parameter sga;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
lock_sga                             boolean     FALSE
pre_page_sga                         boolean     FALSE
sga_max_size                         big integer 6016M
sga_target                           big integer 0

```

### size

```

SQL> show parameter size

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
bitmap_merge_area_size               integer     1048576
client_result_cache_size             big integer 0
create_bitmap_area_size              integer     8388608
db_16k_cache_size                    big integer 0
db_2k_cache_size                     big integer 0
db_32k_cache_size                    big integer 0
db_4k_cache_size                     big integer 0
db_8k_cache_size                     big integer 0
db_block_size                        integer     8192
db_cache_size                        big integer 0
db_flash_cache_size                  big integer 0

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_keep_cache_size                   big integer 0
db_recovery_file_dest_size           big integer 3882M
db_recycle_cache_size                big integer 0
global_context_pool_size             string
hash_area_size                       integer     131072
java_max_sessionspace_size           integer     0
java_pool_size                       big integer 0
large_pool_size                      big integer 0
max_dump_file_size                   string      unlimited
object_cache_max_size_percent        integer     10
object_cache_optimal_size            integer     102400

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
olap_page_pool_size                  big integer 0
parallel_execution_message_size      integer     16384
result_cache_max_size                big integer 16064K
sga_max_size                         big integer 6272M
shared_pool_reserved_size            big integer 36909875
shared_pool_size                     big integer 0
sort_area_retained_size              integer     0
sort_area_size                       integer     65536
streams_pool_size                    big integer 0
workarea_size_policy                 string      AUTO

```

### spfile

```

SQL> show parameter spfile ;

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
spfile                               string      /opt/oracle/product/11.2.0/dbh
                                                 ome_1/dbs/spfilewcsdb.ora

```

### cache

```

SQL> show parameter cache

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
client_result_cache_lag              big integer 3000
client_result_cache_size             big integer 0
db_16k_cache_size                    big integer 0
db_2k_cache_size                     big integer 0
db_32k_cache_size                    big integer 0
db_4k_cache_size                     big integer 0
db_8k_cache_size                     big integer 0
db_cache_advice                      string      ON
db_cache_size                        big integer 0
db_flash_cache_file                  string
db_flash_cache_size                  big integer 0

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
db_keep_cache_size                   big integer 0
db_recycle_cache_size                big integer 0
object_cache_max_size_percent        integer     10
object_cache_optimal_size            integer     102400
result_cache_max_result              integer     5
result_cache_max_size                big integer 16064K
result_cache_mode                    string      MANUAL
result_cache_remote_expiration       integer     0
session_cached_cursors               integer     50

```

### Character Set

```

SQL> select * from V$NLS_VALID_VALUES where parameter='CHARACTERSET' and value like '%UTF%';

PARAMETER							 VALUE								  ISDEP     CON_ID
---------------------------------------------------------------- ---------------------------------------------------------------- ----- ----------
CHARACTERSET							 AL24UTFFSS							  TRUE		 0
CHARACTERSET							 UTF8								  FALSE 	 0
CHARACTERSET							 UTFE								  FALSE 	 0
CHARACTERSET							 AL32UTF8							  FALSE 	 0
CHARACTERSET							 AL16UTF16							  FALSE 	 0

```

```

SQL> select userenv('language') from dual;

USERENV('LANGUAGE')
----------------------------------------------------
AMERICAN_AMERICA.WE8MSWIN1252

```

```

SQL> select * from nls_database_parameters ;

PARAMETER															 VALUE
-------------------------------------------------------------------------------------------------------------------------------- ----------------------------------------------------------------
NLS_RDBMS_VERSION														 12.1.0.2.0
NLS_NCHAR_CONV_EXCP														 FALSE
NLS_LENGTH_SEMANTICS														 BYTE
NLS_COMP															 BINARY
NLS_DUAL_CURRENCY														 $
NLS_TIMESTAMP_TZ_FORMAT 													 DD-MON-RR HH.MI.SSXFF AM TZR
NLS_TIME_TZ_FORMAT														 HH.MI.SSXFF AM TZR
NLS_TIMESTAMP_FORMAT														 DD-MON-RR HH.MI.SSXFF AM
NLS_TIME_FORMAT 														 HH.MI.SSXFF AM
NLS_SORT															 BINARY
NLS_DATE_LANGUAGE														 AMERICAN
NLS_DATE_FORMAT 														 DD-MON-RR
NLS_CALENDAR															 GREGORIAN
NLS_NUMERIC_CHARACTERS														 .,
NLS_NCHAR_CHARACTERSET														 AL16UTF16
NLS_CHARACTERSET														 WE8MSWIN1252
NLS_ISO_CURRENCY														 AMERICA
NLS_CURRENCY															 $
NLS_TERRITORY															 AMERICA
NLS_LANGUAGE															 AMERICAN

20 rows selected.

```

```

SQL> SELECT * FROM v$nls_parameters;

PARAMETER							 VALUE								      CON_ID
---------------------------------------------------------------- ---------------------------------------------------------------- ----------
NLS_LANGUAGE							 AMERICAN								   0
NLS_TERRITORY							 AMERICA								   0
NLS_CURRENCY							 $									   0
NLS_ISO_CURRENCY						 AMERICA								   0
NLS_NUMERIC_CHARACTERS						 .,									   0
NLS_CALENDAR							 GREGORIAN								   0
NLS_DATE_FORMAT 						 DD-MON-RR								   0
NLS_DATE_LANGUAGE						 AMERICAN								   0
NLS_CHARACTERSET						 WE8MSWIN1252								   0
NLS_SORT							 BINARY 								   0
NLS_TIME_FORMAT 						 HH.MI.SSXFF AM 							   0
NLS_TIMESTAMP_FORMAT						 DD-MON-RR HH.MI.SSXFF AM						   0
NLS_TIME_TZ_FORMAT						 HH.MI.SSXFF AM TZR							   0
NLS_TIMESTAMP_TZ_FORMAT 					 DD-MON-RR HH.MI.SSXFF AM TZR						   0
NLS_DUAL_CURRENCY						 $									   0
NLS_NCHAR_CHARACTERSET						 AL16UTF16								   0
NLS_COMP							 BINARY 								   0
NLS_LENGTH_SEMANTICS						 BYTE									   0
NLS_NCHAR_CONV_EXCP						 FALSE									   0

19 rows selected.

```

```

SQL> SELECT * FROM v$nls_valid_values;

PARAMETER							 VALUE								  ISDEP     CON_ID
---------------------------------------------------------------- ---------------------------------------------------------------- ----- ----------
LANGUAGE							 AMERICAN							  FALSE 	 0
LANGUAGE							 GERMAN 							  FALSE 	 0
LANGUAGE							 FRENCH 							  FALSE 	 0
LANGUAGE							 CANADIAN FRENCH						  FALSE 	 0
LANGUAGE							 SPANISH							  FALSE 	 0
LANGUAGE							 ITALIAN							  FALSE 	 0
LANGUAGE							 DUTCH								  FALSE 	 0
LANGUAGE							 SWEDISH							  FALSE 	 0
LANGUAGE							 NORWEGIAN							  FALSE 	 0
LANGUAGE							 DANISH 							  FALSE 	 0
LANGUAGE							 FINNISH							  FALSE 	 0
LANGUAGE							 ICELANDIC							  FALSE 	 0
LANGUAGE							 GREEK								  FALSE 	 0
LANGUAGE							 PORTUGUESE							  FALSE 	 0
LANGUAGE							 TURKISH							  FALSE 	 0
LANGUAGE							 BRAZILIAN PORTUGUESE						  FALSE 	 0
LANGUAGE							 MEXICAN SPANISH						  FALSE 	 0
LANGUAGE							 RUSSIAN							  FALSE 	 0
LANGUAGE							 POLISH 							  FALSE 	 0
LANGUAGE							 HUNGARIAN							  FALSE 	 0
LANGUAGE							 CZECH								  FALSE 	 0
LANGUAGE							 LITHUANIAN							  FALSE 	 0
LANGUAGE							 SLOVAK 							  FALSE 	 0
LANGUAGE							 CATALAN							  FALSE 	 0
LANGUAGE							 BULGARIAN							  FALSE 	 0
LANGUAGE							 ROMANIAN							  FALSE 	 0
LANGUAGE							 SLOVENIAN							  FALSE 	 0
LANGUAGE							 HEBREW 							  FALSE 	 0
LANGUAGE							 EGYPTIAN							  FALSE 	 0
LANGUAGE							 CROATIAN							  FALSE 	 0
LANGUAGE							 ARABIC 							  FALSE 	 0
LANGUAGE							 THAI								  FALSE 	 0
LANGUAGE							 JAPANESE							  FALSE 	 0
LANGUAGE							 KOREAN 							  FALSE 	 0
LANGUAGE							 SIMPLIFIED CHINESE						  FALSE 	 0
LANGUAGE							 TRADITIONAL CHINESE						  FALSE 	 0
LANGUAGE							 ENGLISH							  FALSE 	 0
LANGUAGE							 LATIN AMERICAN SPANISH 					  FALSE 	 0
LANGUAGE							 UKRAINIAN							  FALSE 	 0
LANGUAGE							 ESTONIAN							  FALSE 	 0
LANGUAGE							 GERMAN DIN							  FALSE 	 0
LANGUAGE							 MALAY								  FALSE 	 0
LANGUAGE							 VIETNAMESE							  FALSE 	 0
LANGUAGE							 BENGALI							  TRUE		 0
LANGUAGE							 LATVIAN							  FALSE 	 0
LANGUAGE							 INDONESIAN							  FALSE 	 0
LANGUAGE							 HINDI								  FALSE 	 0
LANGUAGE							 TAMIL								  FALSE 	 0
LANGUAGE							 KANNADA							  FALSE 	 0
LANGUAGE							 TELUGU 							  FALSE 	 0
LANGUAGE							 ORIYA								  FALSE 	 0
LANGUAGE							 MALAYALAM							  FALSE 	 0
LANGUAGE							 ASSAMESE							  FALSE 	 0
LANGUAGE							 GUJARATI							  FALSE 	 0
LANGUAGE							 MARATHI							  FALSE 	 0
LANGUAGE							 PUNJABI							  FALSE 	 0
LANGUAGE							 BANGLA 							  FALSE 	 0
LANGUAGE							 AZERBAIJANI							  FALSE 	 0
LANGUAGE							 MACEDONIAN							  FALSE 	 0
LANGUAGE							 CYRILLIC SERBIAN						  FALSE 	 0
LANGUAGE							 LATIN SERBIAN							  FALSE 	 0
LANGUAGE							 CYRILLIC UZBEK 						  FALSE 	 0
LANGUAGE							 LATIN UZBEK							  FALSE 	 0
LANGUAGE							 CYRILLIC KAZAKH						  FALSE 	 0
LANGUAGE							 ALBANIAN							  FALSE 	 0
LANGUAGE							 BELARUSIAN							  FALSE 	 0
LANGUAGE							 IRISH								  FALSE 	 0
LANGUAGE							 SWAHILI							  FALSE 	 0
LANGUAGE							 DARI								  FALSE 	 0
LANGUAGE							 LATIN BOSNIAN							  FALSE 	 0
LANGUAGE							 AMHARIC							  FALSE 	 0
LANGUAGE							 LAO								  FALSE 	 0
LANGUAGE							 MALTESE							  FALSE 	 0
LANGUAGE							 NEPALI 							  FALSE 	 0
LANGUAGE							 ARMENIAN							  FALSE 	 0
LANGUAGE							 KHMER								  FALSE 	 0
LANGUAGE							 PERSIAN							  FALSE 	 0
LANGUAGE							 DIVEHI 							  FALSE 	 0
LANGUAGE							 SINHALA							  FALSE 	 0
TERRITORY							 AMERICA							  FALSE 	 0
TERRITORY							 UNITED KINGDOM 						  FALSE 	 0
TERRITORY							 GERMANY							  FALSE 	 0
TERRITORY							 FRANCE 							  FALSE 	 0
TERRITORY							 CANADA 							  FALSE 	 0
TERRITORY							 SPAIN								  FALSE 	 0
TERRITORY							 ITALY								  FALSE 	 0
TERRITORY							 THE NETHERLANDS						  FALSE 	 0
TERRITORY							 SWEDEN 							  FALSE 	 0
TERRITORY							 NORWAY 							  FALSE 	 0
TERRITORY							 DENMARK							  FALSE 	 0
TERRITORY							 FINLAND							  FALSE 	 0
TERRITORY							 ICELAND							  FALSE 	 0
TERRITORY							 GREECE 							  FALSE 	 0
TERRITORY							 PORTUGAL							  FALSE 	 0
TERRITORY							 TURKEY 							  FALSE 	 0
TERRITORY							 BRAZIL 							  FALSE 	 0
TERRITORY							 MEXICO 							  FALSE 	 0

PARAMETER							 VALUE								  ISDEP     CON_ID
---------------------------------------------------------------- ---------------------------------------------------------------- ----- ----------
TERRITORY							 CIS								  TRUE		 0
TERRITORY							 CROATIA							  FALSE 	 0
TERRITORY							 POLAND 							  FALSE 	 0
TERRITORY							 HUNGARY							  FALSE 	 0
TERRITORY							 CZECHOSLOVAKIA 						  TRUE		 0
TERRITORY							 LITHUANIA							  FALSE 	 0
TERRITORY							 ISRAEL 							  FALSE 	 0
TERRITORY							 BULGARIA							  FALSE 	 0
TERRITORY							 ALGERIA							  FALSE 	 0
TERRITORY							 BAHRAIN							  FALSE 	 0
TERRITORY							 CATALONIA							  FALSE 	 0
TERRITORY							 EGYPT								  FALSE 	 0
TERRITORY							 IRAQ								  FALSE 	 0
TERRITORY							 JORDAN 							  FALSE 	 0
TERRITORY							 KUWAIT 							  FALSE 	 0
TERRITORY							 LEBANON							  FALSE 	 0
TERRITORY							 LIBYA								  FALSE 	 0
TERRITORY							 MOROCCO							  FALSE 	 0
TERRITORY							 MAURITANIA							  FALSE 	 0
TERRITORY							 OMAN								  FALSE 	 0
TERRITORY							 QATAR								  FALSE 	 0
TERRITORY							 ROMANIA							  FALSE 	 0
TERRITORY							 SAUDI ARABIA							  FALSE 	 0
TERRITORY							 SOMALIA							  FALSE 	 0
TERRITORY							 SYRIA								  FALSE 	 0
TERRITORY							 DJIBOUTI							  FALSE 	 0
TERRITORY							 SLOVENIA							  FALSE 	 0
TERRITORY							 TUNISIA							  FALSE 	 0
TERRITORY							 YEMEN								  FALSE 	 0
TERRITORY							 SUDAN								  FALSE 	 0
TERRITORY							 SWITZERLAND							  FALSE 	 0
TERRITORY							 AUSTRIA							  FALSE 	 0
TERRITORY							 UNITED ARAB EMIRATES						  FALSE 	 0
TERRITORY							 THAILAND							  FALSE 	 0
TERRITORY							 CHINA								  FALSE 	 0
TERRITORY							 HONG KONG							  FALSE 	 0
TERRITORY							 JAPAN								  FALSE 	 0
TERRITORY							 KOREA								  FALSE 	 0
TERRITORY							 TAIWAN 							  FALSE 	 0
TERRITORY							 CZECH REPUBLIC 						  FALSE 	 0
TERRITORY							 SLOVAKIA							  FALSE 	 0
TERRITORY							 UKRAINE							  FALSE 	 0
TERRITORY							 ESTONIA							  FALSE 	 0
TERRITORY							 MALAYSIA							  FALSE 	 0
TERRITORY							 BANGLADESH							  FALSE 	 0
TERRITORY							 LATVIA 							  FALSE 	 0
TERRITORY							 VIETNAM							  FALSE 	 0
TERRITORY							 INDONESIA							  FALSE 	 0
TERRITORY							 CYPRUS 							  FALSE 	 0
TERRITORY							 AUSTRALIA							  FALSE 	 0
TERRITORY							 KAZAKHSTAN							  FALSE 	 0
TERRITORY							 UZBEKISTAN							  FALSE 	 0
TERRITORY							 SINGAPORE							  FALSE 	 0
TERRITORY							 SOUTH AFRICA							  FALSE 	 0
TERRITORY							 IRELAND							  FALSE 	 0
TERRITORY							 BELGIUM							  FALSE 	 0
TERRITORY							 LUXEMBOURG							  FALSE 	 0
TERRITORY							 NEW ZEALAND							  FALSE 	 0
TERRITORY							 INDIA								  FALSE 	 0
TERRITORY							 CHILE								  FALSE 	 0
TERRITORY							 COLOMBIA							  FALSE 	 0
TERRITORY							 COSTA RICA							  FALSE 	 0
TERRITORY							 EL SALVADOR							  FALSE 	 0
TERRITORY							 GUATEMALA							  FALSE 	 0
TERRITORY							 NICARAGUA							  FALSE 	 0
TERRITORY							 PANAMA 							  FALSE 	 0
TERRITORY							 PERU								  FALSE 	 0
TERRITORY							 PUERTO RICO							  FALSE 	 0
TERRITORY							 VENEZUELA							  FALSE 	 0
TERRITORY							 YUGOSLAVIA							  TRUE		 0
TERRITORY							 MACEDONIA							  TRUE		 0
TERRITORY							 RUSSIA 							  FALSE 	 0
TERRITORY							 AZERBAIJAN							  FALSE 	 0
TERRITORY							 FYR MACEDONIA							  FALSE 	 0
TERRITORY							 SERBIA AND MONTENEGRO						  TRUE		 0
TERRITORY							 ARGENTINA							  FALSE 	 0
TERRITORY							 ECUADOR							  FALSE 	 0
TERRITORY							 PHILIPPINES							  FALSE 	 0
TERRITORY							 ALBANIA							  FALSE 	 0
TERRITORY							 BELARUS							  FALSE 	 0
TERRITORY							 SERBIA 							  FALSE 	 0
TERRITORY							 MONTENEGRO							  FALSE 	 0
TERRITORY							 HONDURAS							  FALSE 	 0
TERRITORY							 PAKISTAN							  FALSE 	 0
TERRITORY							 SENEGAL							  FALSE 	 0
TERRITORY							 CAMEROON							  FALSE 	 0
TERRITORY							 CONGO BRAZZAVILLE						  FALSE 	 0
TERRITORY							 CONGO KINSHASA 						  FALSE 	 0
TERRITORY							 GABON								  FALSE 	 0
TERRITORY							 IVORY COAST							  FALSE 	 0
TERRITORY							 BAHAMAS							  FALSE 	 0
TERRITORY							 BERMUDA							  FALSE 	 0
TERRITORY							 NIGERIA							  FALSE 	 0
TERRITORY							 UGANDA 							  FALSE 	 0
TERRITORY							 ZAMBIA 							  FALSE 	 0
TERRITORY							 URUGUAY							  FALSE 	 0
TERRITORY							 KENYA								  FALSE 	 0

PARAMETER							 VALUE								  ISDEP     CON_ID
---------------------------------------------------------------- ---------------------------------------------------------------- ----- ----------
TERRITORY							 TANZANIA							  FALSE 	 0
TERRITORY							 BOLIVIA							  FALSE 	 0
TERRITORY							 BELIZE 							  FALSE 	 0
TERRITORY							 PARAGUAY							  FALSE 	 0
TERRITORY							 AFGHANISTAN							  FALSE 	 0
TERRITORY							 BOSNIA AND HERZEGOVINA 					  FALSE 	 0
TERRITORY							 ETHIOPIA							  FALSE 	 0
TERRITORY							 LAOS								  FALSE 	 0
TERRITORY							 MALTA								  FALSE 	 0
TERRITORY							 NEPAL								  FALSE 	 0
TERRITORY							 ARMENIA							  FALSE 	 0
TERRITORY							 MALDIVES							  FALSE 	 0
TERRITORY							 CAMBODIA							  FALSE 	 0
TERRITORY							 IRAN								  FALSE 	 0
TERRITORY							 SRI LANKA							  FALSE 	 0
CHARACTERSET							 US7ASCII							  FALSE 	 0
CHARACTERSET							 WE8DEC 							  FALSE 	 0
CHARACTERSET							 WE8HP								  FALSE 	 0
CHARACTERSET							 US8PC437							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC37							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC500							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC1140							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC285							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC1146							  FALSE 	 0
CHARACTERSET							 WE8PC850							  FALSE 	 0
CHARACTERSET							 D7DEC								  FALSE 	 0
CHARACTERSET							 F7DEC								  FALSE 	 0
CHARACTERSET							 S7DEC								  FALSE 	 0
CHARACTERSET							 E7DEC								  FALSE 	 0
CHARACTERSET							 SF7ASCII							  FALSE 	 0
CHARACTERSET							 NDK7DEC							  FALSE 	 0
CHARACTERSET							 I7DEC								  FALSE 	 0
CHARACTERSET							 NL7DEC 							  FALSE 	 0
CHARACTERSET							 CH7DEC 							  FALSE 	 0
CHARACTERSET							 YUG7ASCII							  FALSE 	 0
CHARACTERSET							 SF7DEC 							  FALSE 	 0
CHARACTERSET							 TR7DEC 							  FALSE 	 0
CHARACTERSET							 IW7IS960							  FALSE 	 0
CHARACTERSET							 IN8ISCII							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC1148							  FALSE 	 0
CHARACTERSET							 WE8PC858							  FALSE 	 0
CHARACTERSET							 WE8ISO8859P1							  FALSE 	 0
CHARACTERSET							 EE8ISO8859P2							  FALSE 	 0
CHARACTERSET							 SE8ISO8859P3							  FALSE 	 0
CHARACTERSET							 NEE8ISO8859P4							  FALSE 	 0
CHARACTERSET							 CL8ISO8859P5							  FALSE 	 0
CHARACTERSET							 AR8ISO8859P6							  FALSE 	 0
CHARACTERSET							 EL8ISO8859P7							  FALSE 	 0
CHARACTERSET							 IW8ISO8859P8							  FALSE 	 0
CHARACTERSET							 WE8ISO8859P9							  FALSE 	 0
CHARACTERSET							 NE8ISO8859P10							  FALSE 	 0
CHARACTERSET							 TH8TISASCII							  FALSE 	 0
CHARACTERSET							 TH8TISEBCDIC							  FALSE 	 0
CHARACTERSET							 BN8BSCII							  FALSE 	 0
CHARACTERSET							 VN8VN3 							  FALSE 	 0
CHARACTERSET							 VN8MSWIN1258							  FALSE 	 0
CHARACTERSET							 WE8ISO8859P15							  FALSE 	 0
CHARACTERSET							 BLT8ISO8859P13 						  FALSE 	 0
CHARACTERSET							 CEL8ISO8859P14 						  FALSE 	 0
CHARACTERSET							 CL8ISOIR111							  FALSE 	 0
CHARACTERSET							 WE8NEXTSTEP							  FALSE 	 0
CHARACTERSET							 CL8KOI8U							  FALSE 	 0
CHARACTERSET							 AZ8ISO8859P9E							  FALSE 	 0
CHARACTERSET							 AR8ASMO708PLUS 						  TRUE		 0
CHARACTERSET							 AR8EBCDICX							  FALSE 	 0
CHARACTERSET							 AR8XBASIC							  TRUE		 0
CHARACTERSET							 EL8DEC 							  FALSE 	 0
CHARACTERSET							 TR8DEC 							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC37C							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC500C							  FALSE 	 0
CHARACTERSET							 IW8EBCDIC424							  FALSE 	 0
CHARACTERSET							 TR8EBCDIC1026							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC871							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC284							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC1047							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC1140C 						  FALSE 	 0
CHARACTERSET							 WE8EBCDIC1145							  FALSE 	 0
CHARACTERSET							 WE8EBCDIC1148C 						  FALSE 	 0
CHARACTERSET							 WE8EBCDIC1047E 						  FALSE 	 0
CHARACTERSET							 WE8EBCDIC924							  FALSE 	 0
CHARACTERSET							 EEC8EUROASCI							  FALSE 	 0
CHARACTERSET							 EEC8EUROPA3							  FALSE 	 0
CHARACTERSET							 LA8PASSPORT							  FALSE 	 0
CHARACTERSET							 BG8PC437S							  FALSE 	 0
CHARACTERSET							 EE8PC852							  FALSE 	 0
CHARACTERSET							 RU8PC866							  FALSE 	 0
CHARACTERSET							 RU8BESTA							  FALSE 	 0
CHARACTERSET							 IW8PC1507							  FALSE 	 0
CHARACTERSET							 RU8PC855							  FALSE 	 0
CHARACTERSET							 TR8PC857							  FALSE 	 0
CHARACTERSET							 CL8MACCYRILLIC 						  FALSE 	 0
CHARACTERSET							 CL8MACCYRILLICS						  FALSE 	 0
CHARACTERSET							 WE8PC860							  FALSE 	 0
CHARACTERSET							 IS8PC861							  FALSE 	 0
CHARACTERSET							 EE8MACCES							  FALSE 	 0
CHARACTERSET							 EE8MACCROATIANS						  FALSE 	 0
CHARACTERSET							 TR8MACTURKISHS 						  FALSE 	 0

PARAMETER							 VALUE								  ISDEP     CON_ID
---------------------------------------------------------------- ---------------------------------------------------------------- ----- ----------
CHARACTERSET							 IS8MACICELANDICS						  FALSE 	 0
CHARACTERSET							 EL8MACGREEKS							  FALSE 	 0
CHARACTERSET							 IW8MACHEBREWS							  FALSE 	 0
CHARACTERSET							 EE8MSWIN1250							  FALSE 	 0
CHARACTERSET							 CL8MSWIN1251							  FALSE 	 0
CHARACTERSET							 ET8MSWIN923							  FALSE 	 0
CHARACTERSET							 BG8MSWIN							  FALSE 	 0
CHARACTERSET							 EL8MSWIN1253							  FALSE 	 0
CHARACTERSET							 IW8MSWIN1255							  FALSE 	 0
CHARACTERSET							 LT8MSWIN921							  FALSE 	 0
CHARACTERSET							 TR8MSWIN1254							  FALSE 	 0
CHARACTERSET							 WE8MSWIN1252							  FALSE 	 0
CHARACTERSET							 BLT8MSWIN1257							  FALSE 	 0
CHARACTERSET							 D8EBCDIC273							  FALSE 	 0
CHARACTERSET							 I8EBCDIC280							  FALSE 	 0
CHARACTERSET							 DK8EBCDIC277							  FALSE 	 0
CHARACTERSET							 S8EBCDIC278							  FALSE 	 0
CHARACTERSET							 EE8EBCDIC870							  FALSE 	 0
CHARACTERSET							 CL8EBCDIC1025							  FALSE 	 0
CHARACTERSET							 F8EBCDIC297							  FALSE 	 0
CHARACTERSET							 IW8EBCDIC1086							  FALSE 	 0
CHARACTERSET							 CL8EBCDIC1025X 						  FALSE 	 0
CHARACTERSET							 D8EBCDIC1141							  FALSE 	 0
CHARACTERSET							 N8PC865							  FALSE 	 0
CHARACTERSET							 BLT8CP921							  FALSE 	 0
CHARACTERSET							 LV8PC1117							  FALSE 	 0
CHARACTERSET							 LV8PC8LR							  FALSE 	 0
CHARACTERSET							 BLT8EBCDIC1112 						  FALSE 	 0
CHARACTERSET							 LV8RST104090							  FALSE 	 0
CHARACTERSET							 CL8KOI8R							  FALSE 	 0
CHARACTERSET							 BLT8PC775							  FALSE 	 0
CHARACTERSET							 DK8EBCDIC1142							  FALSE 	 0
CHARACTERSET							 S8EBCDIC1143							  FALSE 	 0
CHARACTERSET							 I8EBCDIC1144							  FALSE 	 0
CHARACTERSET							 F7SIEMENS9780X 						  FALSE 	 0
CHARACTERSET							 E7SIEMENS9780X 						  FALSE 	 0
CHARACTERSET							 S7SIEMENS9780X 						  FALSE 	 0
CHARACTERSET							 DK7SIEMENS9780X						  FALSE 	 0
CHARACTERSET							 N7SIEMENS9780X 						  FALSE 	 0
CHARACTERSET							 I7SIEMENS9780X 						  FALSE 	 0
CHARACTERSET							 D7SIEMENS9780X 						  FALSE 	 0
CHARACTERSET							 F8EBCDIC1147							  FALSE 	 0
CHARACTERSET							 WE8GCOS7							  FALSE 	 0
CHARACTERSET							 EL8GCOS7							  FALSE 	 0
CHARACTERSET							 US8BS2000							  FALSE 	 0
CHARACTERSET							 D8BS2000							  FALSE 	 0
CHARACTERSET							 F8BS2000							  FALSE 	 0
CHARACTERSET							 E8BS2000							  FALSE 	 0
CHARACTERSET							 DK8BS2000							  FALSE 	 0
CHARACTERSET							 S8BS2000							  FALSE 	 0
CHARACTERSET							 WE8BS2000E							  FALSE 	 0
CHARACTERSET							 WE8BS2000							  FALSE 	 0
CHARACTERSET							 EE8BS2000							  FALSE 	 0
CHARACTERSET							 CE8BS2000							  FALSE 	 0
CHARACTERSET							 CL8BS2000							  FALSE 	 0
CHARACTERSET							 WE8BS2000L5							  FALSE 	 0
CHARACTERSET							 WE8DG								  FALSE 	 0
CHARACTERSET							 WE8NCR4970							  FALSE 	 0
CHARACTERSET							 WE8ROMAN8							  FALSE 	 0
CHARACTERSET							 EE8MACCE							  FALSE 	 0
CHARACTERSET							 EE8MACCROATIAN 						  FALSE 	 0
CHARACTERSET							 TR8MACTURKISH							  FALSE 	 0
CHARACTERSET							 IS8MACICELANDIC						  FALSE 	 0
CHARACTERSET							 EL8MACGREEK							  FALSE 	 0
CHARACTERSET							 IW8MACHEBREW							  FALSE 	 0
CHARACTERSET							 US8ICL 							  FALSE 	 0
CHARACTERSET							 WE8ICL 							  FALSE 	 0
CHARACTERSET							 WE8ISOICLUK							  FALSE 	 0
CHARACTERSET							 EE8EBCDIC870C							  FALSE 	 0
CHARACTERSET							 EL8EBCDIC875S							  TRUE		 0
CHARACTERSET							 TR8EBCDIC1026S 						  FALSE 	 0
CHARACTERSET							 BLT8EBCDIC1112S						  FALSE 	 0
CHARACTERSET							 IW8EBCDIC424S							  FALSE 	 0
CHARACTERSET							 EE8EBCDIC870S							  FALSE 	 0
CHARACTERSET							 CL8EBCDIC1025S 						  FALSE 	 0
CHARACTERSET							 TH8TISEBCDICS							  FALSE 	 0
CHARACTERSET							 AR8EBCDIC420S							  FALSE 	 0
CHARACTERSET							 CL8EBCDIC1025C 						  FALSE 	 0
CHARACTERSET							 CL8EBCDIC1025R 						  FALSE 	 0
CHARACTERSET							 EL8EBCDIC875R							  FALSE 	 0
CHARACTERSET							 CL8EBCDIC1158							  FALSE 	 0
CHARACTERSET							 CL8EBCDIC1158R 						  FALSE 	 0
CHARACTERSET							 EL8EBCDIC423R							  FALSE 	 0
CHARACTERSET							 WE8MACROMAN8							  FALSE 	 0
CHARACTERSET							 WE8MACROMAN8S							  FALSE 	 0
CHARACTERSET							 TH8MACTHAI							  FALSE 	 0
CHARACTERSET							 TH8MACTHAIS							  FALSE 	 0
CHARACTERSET							 HU8CWI2							  FALSE 	 0
CHARACTERSET							 EL8PC437S							  FALSE 	 0
CHARACTERSET							 EL8EBCDIC875							  FALSE 	 0
CHARACTERSET							 EL8PC737							  FALSE 	 0
CHARACTERSET							 LT8PC772							  FALSE 	 0
CHARACTERSET							 LT8PC774							  FALSE 	 0
CHARACTERSET							 EL8PC869							  FALSE 	 0
CHARACTERSET							 EL8PC851							  FALSE 	 0
CHARACTERSET							 CDN8PC863							  FALSE 	 0
CHARACTERSET							 HU8ABMOD							  FALSE 	 0

PARAMETER							 VALUE								  ISDEP     CON_ID
---------------------------------------------------------------- ---------------------------------------------------------------- ----- ----------
CHARACTERSET							 AR8ASMO8X							  FALSE 	 0
CHARACTERSET							 AR8NAFITHA711T 						  TRUE		 0
CHARACTERSET							 AR8SAKHR707T							  TRUE		 0
CHARACTERSET							 AR8MUSSAD768T							  TRUE		 0
CHARACTERSET							 AR8ADOS710T							  TRUE		 0
CHARACTERSET							 AR8ADOS720T							  TRUE		 0
CHARACTERSET							 AR8APTEC715T							  TRUE		 0
CHARACTERSET							 AR8NAFITHA721T 						  TRUE		 0
CHARACTERSET							 AR8HPARABIC8T							  TRUE		 0
CHARACTERSET							 AR8NAFITHA711							  FALSE 	 0
CHARACTERSET							 AR8SAKHR707							  FALSE 	 0
CHARACTERSET							 AR8MUSSAD768							  FALSE 	 0
CHARACTERSET							 AR8ADOS710							  FALSE 	 0
CHARACTERSET							 AR8ADOS720							  FALSE 	 0
CHARACTERSET							 AR8APTEC715							  FALSE 	 0
CHARACTERSET							 AR8MSWIN1256							  FALSE 	 0
CHARACTERSET							 AR8NAFITHA721							  FALSE 	 0
CHARACTERSET							 AR8SAKHR706							  FALSE 	 0
CHARACTERSET							 AR8ARABICMAC							  FALSE 	 0
CHARACTERSET							 AR8ARABICMACS							  FALSE 	 0
CHARACTERSET							 AR8ARABICMACT							  TRUE		 0
CHARACTERSET							 LA8ISO6937							  FALSE 	 0
CHARACTERSET							 JA16VMS							  FALSE 	 0
CHARACTERSET							 JA16EUC							  FALSE 	 0
CHARACTERSET							 JA16EUCYEN							  FALSE 	 0
CHARACTERSET							 JA16SJIS							  FALSE 	 0
CHARACTERSET							 JA16DBCS							  FALSE 	 0
CHARACTERSET							 JA16SJISYEN							  FALSE 	 0
CHARACTERSET							 JA16EBCDIC930							  FALSE 	 0
CHARACTERSET							 JA16MACSJIS							  FALSE 	 0
CHARACTERSET							 JA16EUCTILDE							  FALSE 	 0
CHARACTERSET							 JA16SJISTILDE							  FALSE 	 0
CHARACTERSET							 KO16KSC5601							  FALSE 	 0
CHARACTERSET							 KO16DBCS							  FALSE 	 0
CHARACTERSET							 KO16KSCCS							  FALSE 	 0
CHARACTERSET							 KO16MSWIN949							  FALSE 	 0
CHARACTERSET							 ZHS16CGB231280 						  FALSE 	 0
CHARACTERSET							 ZHS16MACCGB231280						  FALSE 	 0
CHARACTERSET							 ZHS16GBK							  FALSE 	 0
CHARACTERSET							 ZHS16DBCS							  FALSE 	 0
CHARACTERSET							 ZHS32GB18030							  FALSE 	 0
CHARACTERSET							 ZHT32EUC							  FALSE 	 0
CHARACTERSET							 ZHT32SOPS							  FALSE 	 0
CHARACTERSET							 ZHT16DBT							  FALSE 	 0
CHARACTERSET							 ZHT32TRIS							  FALSE 	 0
CHARACTERSET							 ZHT16DBCS							  FALSE 	 0
CHARACTERSET							 ZHT16BIG5							  FALSE 	 0
CHARACTERSET							 ZHT16CCDC							  FALSE 	 0
CHARACTERSET							 ZHT16MSWIN950							  FALSE 	 0
CHARACTERSET							 ZHT16HKSCS							  FALSE 	 0
CHARACTERSET							 AL24UTFFSS							  TRUE		 0
CHARACTERSET							 UTF8								  FALSE 	 0
CHARACTERSET							 UTFE								  FALSE 	 0
CHARACTERSET							 AL32UTF8							  FALSE 	 0
CHARACTERSET							 ZHT16HKSCS31							  FALSE 	 0
CHARACTERSET							 JA16EUCFIXED							  TRUE		 0
CHARACTERSET							 JA16SJISFIXED							  TRUE		 0
CHARACTERSET							 JA16DBCSFIXED							  TRUE		 0
CHARACTERSET							 KO16KSC5601FIXED						  TRUE		 0
CHARACTERSET							 KO16DBCSFIXED							  TRUE		 0
CHARACTERSET							 ZHS16CGB231280FIXED						  TRUE		 0
CHARACTERSET							 ZHS16GBKFIXED							  TRUE		 0
CHARACTERSET							 ZHS16DBCSFIXED 						  TRUE		 0
CHARACTERSET							 ZHT32EUCFIXED							  TRUE		 0
CHARACTERSET							 ZHT32TRISFIXED 						  TRUE		 0
CHARACTERSET							 ZHT16DBCSFIXED 						  TRUE		 0
CHARACTERSET							 ZHT16BIG5FIXED 						  TRUE		 0
CHARACTERSET							 AL16UTF16							  FALSE 	 0
SORT								 BINARY 							  FALSE 	 0
SORT								 WEST_EUROPEAN							  FALSE 	 0
SORT								 XWEST_EUROPEAN 						  FALSE 	 0
SORT								 GERMAN 							  FALSE 	 0
SORT								 XGERMAN							  FALSE 	 0
SORT								 DANISH 							  FALSE 	 0
SORT								 XDANISH							  FALSE 	 0
SORT								 SPANISH							  FALSE 	 0
SORT								 XSPANISH							  FALSE 	 0
SORT								 GERMAN_DIN							  FALSE 	 0
SORT								 XGERMAN_DIN							  FALSE 	 0
SORT								 FINNISH							  FALSE 	 0
SORT								 FRENCH 							  FALSE 	 0
SORT								 NORWEGIAN							  FALSE 	 0
SORT								 SWEDISH							  FALSE 	 0
SORT								 ITALIAN							  FALSE 	 0
SORT								 ICELANDIC							  FALSE 	 0
SORT								 DUTCH								  FALSE 	 0
SORT								 XDUTCH 							  FALSE 	 0
SORT								 SWISS								  FALSE 	 0
SORT								 XSWISS 							  FALSE 	 0
SORT								 ARABIC 							  FALSE 	 0
SORT								 HUNGARIAN							  FALSE 	 0
SORT								 XHUNGARIAN							  FALSE 	 0
SORT								 GREEK								  FALSE 	 0
SORT								 CZECH								  FALSE 	 0
SORT								 XCZECH 							  FALSE 	 0
SORT								 POLISH 							  FALSE 	 0
SORT								 SLOVAK 							  FALSE 	 0

PARAMETER							 VALUE								  ISDEP     CON_ID
---------------------------------------------------------------- ---------------------------------------------------------------- ----- ----------
SORT								 XSLOVAK							  FALSE 	 0
SORT								 LATIN								  FALSE 	 0
SORT								 THAI_DICTIONARY						  TRUE		 0
SORT								 THAI_TELEPHONE 						  TRUE		 0
SORT								 TURKISH							  FALSE 	 0
SORT								 XTURKISH							  FALSE 	 0
SORT								 RUSSIAN							  FALSE 	 0
SORT								 HEBREW 							  FALSE 	 0
SORT								 LITHUANIAN							  FALSE 	 0
SORT								 CROATIAN							  FALSE 	 0
SORT								 XCROATIAN							  FALSE 	 0
SORT								 ROMANIAN							  FALSE 	 0
SORT								 BULGARIAN							  FALSE 	 0
SORT								 CATALAN							  FALSE 	 0
SORT								 XCATALAN							  FALSE 	 0
SORT								 SLOVENIAN							  FALSE 	 0
SORT								 XSLOVENIAN							  FALSE 	 0
SORT								 UKRAINIAN							  FALSE 	 0
SORT								 ESTONIAN							  FALSE 	 0
SORT								 ASCII7 							  FALSE 	 0
SORT								 JAPANESE							  TRUE		 0
SORT								 MALAY								  FALSE 	 0
SORT								 PUNCTUATION							  FALSE 	 0
SORT								 XPUNCTUATION							  FALSE 	 0
SORT								 CANADIAN FRENCH						  TRUE		 0
SORT								 VIETNAMESE							  FALSE 	 0
SORT								 EEC_EURO							  FALSE 	 0
SORT								 LATVIAN							  FALSE 	 0
SORT								 BENGALI							  FALSE 	 0
SORT								 XFRENCH							  FALSE 	 0
SORT								 INDONESIAN							  FALSE 	 0
SORT								 ARABIC_MATCH							  FALSE 	 0
SORT								 ARABIC_ABJ_SORT						  FALSE 	 0
SORT								 ARABIC_ABJ_MATCH						  FALSE 	 0
SORT								 EEC_EUROPA3							  FALSE 	 0
SORT								 CZECH_PUNCTUATION						  FALSE 	 0
SORT								 XCZECH_PUNCTUATION						  FALSE 	 0
SORT								 UNICODE_BINARY 						  FALSE 	 0
SORT								 EBCDIC 							  FALSE 	 0
SORT								 GENERIC_BASELETTER						  FALSE 	 0
SORT								 AZERBAIJANI							  FALSE 	 0
SORT								 XAZERBAIJANI							  FALSE 	 0
SORT								 GENERIC_M							  FALSE 	 0
SORT								 SPANISH_M							  FALSE 	 0
SORT								 FRENCH_M							  FALSE 	 0
SORT								 THAI_M 							  FALSE 	 0
SORT								 CANADIAN_M							  FALSE 	 0
SORT								 DANISH_M							  FALSE 	 0
SORT								 TCHINESE_RADICAL_M						  FALSE 	 0
SORT								 BIG5								  FALSE 	 0
SORT								 HKSCS								  FALSE 	 0
SORT								 TCHINESE_STROKE_M						  FALSE 	 0
SORT								 SCHINESE_PINYIN_M						  FALSE 	 0
SORT								 SCHINESE_STROKE_M						  FALSE 	 0
SORT								 GBK								  FALSE 	 0
SORT								 SCHINESE_RADICAL_M						  FALSE 	 0
SORT								 JAPANESE_M							  FALSE 	 0
SORT								 KOREAN_M							  FALSE 	 0
SORT								 UCA0610_ROOT							  FALSE 	 0
SORT								 UCA0610_DUCET							  FALSE 	 0
SORT								 UCA0610_SPANISH						  FALSE 	 0
SORT								 UCA0610_TSPANISH						  FALSE 	 0
SORT								 UCA0610_CFRENCH						  FALSE 	 0
SORT								 UCA0610_DANISH 						  FALSE 	 0
SORT								 UCA0610_THAI							  FALSE 	 0
SORT								 UCA0610_JAPANESE						  FALSE 	 0
SORT								 UCA0610_KOREAN 						  FALSE 	 0
SORT								 UCA0610_SCHINESE						  FALSE 	 0
SORT								 UCA0610_SCHINESE1						  FALSE 	 0
SORT								 UCA0610_SCHINESE2						  FALSE 	 0
SORT								 UCA0610_TCHINESE						  FALSE 	 0
SORT								 UCA0610_TCHINESE1						  FALSE 	 0
SORT								 UCA0620_ROOT							  FALSE 	 0
SORT								 UCA0620_DUCET							  FALSE 	 0
SORT								 UCA0620_SPANISH						  FALSE 	 0
SORT								 UCA0620_TSPANISH						  FALSE 	 0
SORT								 UCA0620_CFRENCH						  FALSE 	 0
SORT								 UCA0620_DANISH 						  FALSE 	 0
SORT								 UCA0620_THAI							  FALSE 	 0
SORT								 UCA0620_JAPANESE						  FALSE 	 0
SORT								 UCA0620_KOREAN 						  FALSE 	 0
SORT								 UCA0620_SCHINESE						  FALSE 	 0
SORT								 UCA0620_SCHINESE1						  FALSE 	 0
SORT								 UCA0620_SCHINESE2						  FALSE 	 0
SORT								 UCA0620_TCHINESE						  FALSE 	 0
SORT								 UCA0620_TCHINESE1						  FALSE 	 0

571 rows selected.

```

## 进程

```
select * from v$process		

```

## 查看用户

查看当前用户

```
select user from dual;		

```

查看所有用户

```
select * from all_users		

```

```
select username from dba_users;		

```

## 显示表

```
select * from tab where tabtype='SYNONYM';

```

```
select name,type,referenced_name from user_dependencies;

```

## 显示试图

```
select object_name,created,status from user_objects where object_type in ('VIEW')

```

## PROCEDURE

```
select object_name,created,status from user_objects where object_type in ('PROCEDURE')

```

## FUNCTION

```
select object_name,created,status from user_objects where object_type in ('FUNCTION')

```

## 视图、存储过程、函数

查询数据库中的视图、存储过程、函数

```
select object_name,created,status
from user_objects
where object_type in ('PROCEDURE','FUNCTION','VIEW')

```

## 查看存储过程源代码

```
select text from user_source where name = 'ADD_DEPT';

select text from all_source where name = 'ADD_DEPT';

```

## 日期时间格式

```

export NLS_LANG=AMERICAN       ---要注意这一句必须指定，不然下一句不生效。
export NLS_DATE_FORMAT='yyyy-mm-dd hh24:mi:ss'

```

### Date

修改当前会话的日期格式

```
alter session set nls_date_format='YYYY-MM-DD HH24:MI:SS';

```

查看本次会话定义

```
select * from nls_session_parameters where parameter = 'NLS_DATE_FORMAT';

```

查看本次会话定义

```
SELECT * FROM v$nls_parameters where parameter = 'NLS_DATE_FORMAT';

```

### 修改系统日期格式

查看数据库定义

```
alter system set nls_date_format='yyyy-mm-dd hh24:mi:ss' scope=spfile;
select * from nls_database_parameters where parameter = 'NLS_DATE_FORMAT';

```

### TIMESTAMP

```
ALTER SESSION SET NLS_TIMESTAMP_TZ_FORMAT='DD-MON-RR HH:MI:SSXFF AM TZR';			

```

查看数据库时区信息

```

select dbtimezone from dual;

```

查看 session 时区信息：

```
select sessiontimezone from dual;			

```

```
Database 的 timezone 可以在创建数据库的时候指定，如：
CREATE DATABASE db01
...
SET TIME_ZONE='+08:00';
或者在数据库创建之后通过 alter database 语句修改，但是只有重启数据库后有效：
ALTER DATABASE SET TIME_ZONE='+08:00';
session 的 timezone 可以简单通过 alter session 语句修改：
ALTER SESSION SET TIME_ZONE='+08:00';			

```

## 切换字符集

### 切换到 GBK

```

SQL> shutdown immediate;
SQL> startup mount;
SQL> alter system enable restricted session;
SQL> alter system set job_queue_processes=0;
SQL> alter database open;
SQL> alter database character set internal_use ZHS16GBK;
SQL> shutdown immediate;
SQL> startup
SQL> alter system disable restricted session;

```

### 切到 UTF-8

```

sqlplus "/ as sysdba"
SQL> SHUTDOWN IMMEDIATE
SQL> STARTUP MOUNT
SQL> ALTER SYSTEM ENABLE RESTRICTED SESSION;
SQL> ALTER SYSTEM SET JOB_QUEUE_PROCESSES=0;
SQL> ALTER SYSTEM SET AQ_TM_PROCESSES=0;
SQL> ALTER DATABASE OPEN
SQL> ALTER DATABASE NATIONAL CHARACTER SETINTERNAL_USE UTF8;
SQL> SHUTDOWN IMMEDIATE
SQL> STARTUP

```

### 切到 AL32UTF8

```

SQL> shutdown immediate;
SQL> startup mount;
SQL> alter system enable restricted session;
SQL> alter system set job_queue_processes=0;
SQL> alter database open;
SQL> alter database character set internal_use AL32UTF8;
SQL> shutdown immediate;
SQL> startup
SQL> alter system disable restricted session;

```

### 切换过程实例

例 43.1. Oracle 字符集切换实例

```

C:\Users\Administrator>sqlplus

SQL*Plus: Release 11.2.0.1.0 Production on Mon Nov 30 17:01:10 2015

Copyright (c) 1982, 2010, Oracle.  All rights reserved.

Enter user-name: sys as sysdba
Enter password:

Connected to:
Oracle Database 11g Release 11.2.0.1.0 - 64bit Production

SQL> shutdown immediate;
Database closed.
Database dismounted.
ORACLE instance shut down.
SQL> startup mount;
ORACLE instance started.

Total System Global Area 3423965184 bytes
Fixed Size                  2180544 bytes
Variable Size            1879050816 bytes
Database Buffers         1526726656 bytes
Redo Buffers               16007168 bytes
Database mounted.
SQL> alter system enable restricted session;

System altered.

SQL> alter system set job_queue_processes=0;

System altered.

SQL> alter database open;

Database altered.

SQL> ALTER DATABASE character set INTERNAL_USE ZHS16GBK;

Database altered.

SQL> shutdown immediate;
Database closed.
Database dismounted.
ORACLE instance shut down.
SQL> startup
ORACLE instance started.

Total System Global Area 3423965184 bytes
Fixed Size                  2180544 bytes
Variable Size            1879050816 bytes
Database Buffers         1526726656 bytes
Redo Buffers               16007168 bytes
Database mounted.
Database opened.
SQL> alter system disable restricted session;

System altered.

SQL>

SQL> select userenv('language') from dual;

USERENV('LANGUAGE')
----------------------------------------------------
AMERICAN_AMERICA.ZHS16GBK

SQL>

```

## Oracle 表空间

### 查询空闲表空间

```
select tablespace_name,file_id,block_id,bytes,blocks from dba_free_space;

```

```

SQL> select file_name from dba_data_files;

FILE_NAME
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
/opt/oracle/oradata/orcl/users01.dbf
/opt/oracle/oradata/orcl/undotbs01.dbf
/opt/oracle/oradata/orcl/sysaux01.dbf
/opt/oracle/oradata/orcl/system01.dbf
/opt/oracle/oradata/orcl/example01.dbf
/opt/oracle/oradata/orcl/neo.dbf

6 rows selected.		

```

### 创建表空间

```
create tablespace test
datafile '/opt/app/oracle/oradata/test.dbf' size 8M
autoextend on
next 5M
maxsize 10M;

```

maxsize unlimited 是大小不受限制

```
create tablespace test
datafile '/opt/app/oracle/oradata/test.dbf' size 800M
autoextend on
next 50M
maxsize unlimited

```

unform 表示区的大小相同，默认为 1M

```
create tablespace test
datafile '/opt/app/oracle/oradata/test.dbf' size 800M
autoextend on
next 50M
maxsize 1000M
extent management local uniform;

```

unform size 500K 表示区的大小相同，为 500K

```
create tablespace test
datafile '/opt/app/oracle/oradata/test.dbf' size 800M
autoextend on
next 50M
maxsize 1000M
extent management local uniform size 500K;

```

autoallocate 表示区的大小由随表的大小自动动态改变

```
create tablespace test
datafile '/opt/app/oracle/oradata/test.dbf' size 800M
autoextend on
next 50M
maxsize 1000M
extent management local autoallocate;

```

temporary 创建字典管理临时表空间

```
create tablespace test
datafile '/opt/app/oracle/oradata/test.dbf' size 800M
autoextend on
next 50M
maxsize 1000M
temporary;

```

例 43.2. 创建表空间实例

```

SQL> create tablespace ts_b01_def datafile '/opt/oracle/oradata/orcl/ts_b01_def.dbf' size 100m autoextend on;

Tablespace created.

SQL> create tablespace ts_b01_idx datafile '/opt/oracle/oradata/orcl/ts_b01_idx.dbf' size 100m autoextend on;

Tablespace created.			

```

#### 临时表空间

创建临时表空间，语句中的 datafile 都换为 tempfile

```
create temporary tablespace test
tempfile '/opt/app/oracle/oradata/test.dbf' size 800M
autoextend on
next 50M
maxsize 1000M

```

### 更改表空间属性

更改自动扩展属性

```
alter database datafile
    '/opt/app/oracle/oradata/test.dbf',
    '/opt/app/oracle/oradata/test01.dbf'
    '/opt/app/oracle/oradata/test02.dbf'
    autoextend off;

```

#### 修改表空间大小

```
先查询数据文件名称、大小和路径的信息，语句如下：

select tablespace_name,file_id,bytes,file_name from dba_data_files;

增加表空间，修改文件大小语句如下

alter database datafile '需要增加的数据文件路径，即上面查询出来的路径 ' resize 800M;

```

### 删除表空间

```
drop tablespace "空间名" including contents and datafiles

drop tablespace test including contents and datafiles

```

## 第 44 章 命令工具

## mongo - MongoDB Shell

### eval

```

# mongo
MongoDB shell version: 2.2.3
connecting to: test
Welcome to the MongoDB shell.
For interactive help, type "help".
For more comprehensive documentation, see
	http://docs.mongodb.org/
Questions? Try the support group
	http://groups.google.com/group/mongodb-user
>

```

3.4

```

[root@netkiller ~]# mongo
MongoDB shell version v3.4.1
connecting to: mongodb://127.0.0.1:27017
MongoDB server version: 3.4.1
Server has startup warnings: 
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] 
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] ** WARNING: Access control is not enabled for the database.
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] **          Read and write access to data and configuration is unrestricted.
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] 
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] 
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is 'always'.
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] 
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is 'always'.
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] **        We suggest setting it to 'never'
2017-01-03T11:26:57.516+0800 I CONTROL  [initandlisten] 
>

```

```
				# mongo 127.0.0.1:27017/admin --eval "db.stats()"

```

### help

help

```
				db.help() help on DB methods
				db.foo.help() help on collection methods

```

### 登陆认证

```

# mongo -u<user> -p<password> --authenticationDatabase <db> <host>/<db> 

```

### 管道操作

```

cat data.bson | mongo test

```

## mongodump - Backup

```

# mongodump -uneo -p -d test -o /tmp/
connected to: 127.0.0.1
Enter password:
Tue Sep 8 10:12:33.011 DATABASE: test to /tmp/test
Tue Sep 8 10:12:33.012 test.system.indexes to /tmp/test/system.indexes.bson
Tue Sep 8 10:12:33.043 12 objects
Tue Sep 8 10:12:33.043 test.bios to /tmp/test/bios.bson
Tue Sep 8 10:12:33.043 1 objects
Tue Sep 8 10:12:33.043 Metadata for test.bios to /tmp/test/bios.metadata.json
Tue Sep 8 10:12:33.043 test.system.users to /tmp/test/system.users.bson
Tue Sep 8 10:12:33.044 2 objects
Tue Sep 8 10:12:33.044 Metadata for test.system.users to /tmp/test/system.users.metadata.json
Tue Sep 8 10:12:33.044 test.fs.chunks to /tmp/test/fs.chunks.bson
Tue Sep 8 10:12:33.045 2 objects
Tue Sep 8 10:12:33.045 Metadata for test.fs.chunks to /tmp/test/fs.chunks.metadata.json
Tue Sep 8 10:12:33.045 test.fs.files to /tmp/test/fs.files.bson
Tue Sep 8 10:12:33.046 2 objects
Tue Sep 8 10:12:33.046 Metadata for test.fs.files to /tmp/test/fs.files.metadata.json
Tue Sep 8 10:12:33.046 test.images.chunks to /tmp/test/images.chunks.bson
Tue Sep 8 10:12:33.167 12 objects
Tue Sep 8 10:12:33.167 Metadata for test.images.chunks to /tmp/test/images.chunks.metadata.json
Tue Sep 8 10:12:33.167 test.images.files to /tmp/test/images.files.bson
Tue Sep 8 10:12:33.168 3 objects
Tue Sep 8 10:12:33.168 Metadata for test.images.files to /tmp/test/images.files.metadata.json
Tue Sep 8 10:12:33.168 test.img.chunks to /tmp/test/img.chunks.bson
Tue Sep 8 10:12:33.175 4 objects
Tue Sep 8 10:12:33.175 Metadata for test.img.chunks to /tmp/test/img.chunks.metadata.json
Tue Sep 8 10:12:33.175 test.img.files to /tmp/test/img.files.bson
Tue Sep 8 10:12:33.176 1 objects
Tue Sep 8 10:12:33.176 Metadata for test.img.files to /tmp/test/img.files.metadata.json

```

### 远程备份

短参数

```

mongodump -h mongodb.example.net -p 27017 -u neo -p password -d netkiller -c yourcollection

```

长参数

```

mongodump --host mongodb.example.net --port 27017 --username backup --password passwd --db mdb --collection some

```

### 本地备份

通过指定 dbpath 在本地导出 bson 文件

```

mongodump --dbpath /var/lib/mongodb --out /opt/backup --db test --username backup --password passwd

```

## mongorestore

直接从 dump 回复备份

```

[root@netkiller www]# ls
backup dump

[root@netkiller www]# mongorestore dump/

```

```

[root@netkiller www]# mongorestore -h 127.0.0.1 -u neo -p chen /tmp/test/
connected to: 127.0.0.1
Tue Sep 8 10:18:31.360 /tmp/test/system.users.bson
Tue Sep 8 10:18:31.360 going into namespace [test.system.users]
Tue Sep 8 10:18:31.361 warning: Restoring to test.system.users without dropping. Restored data will be inserted without raising errors; check your server log
2 objects found
Tue Sep 8 10:18:31.361 Creating index: { key: { _id: 1 }, ns: "test.system.users", name: "_id_" }
Tue Sep 8 10:18:31.406 Creating index: { key: { user: 1, userSource: 1 }, unique: true, ns: "test.system.users", name: "user_1_userSource_1" }
Tue Sep 8 10:18:31.406 /tmp/test/img.chunks.bson
Tue Sep 8 10:18:31.406 going into namespace [test.img.chunks]
Tue Sep 8 10:18:31.407 warning: Restoring to test.img.chunks without dropping. Restored data will be inserted without raising errors; check your server log
4 objects found
Tue Sep 8 10:18:31.409 Creating index: { name: "_id_", key: { _id: 1 }, ns: "test.img.chunks" }
Tue Sep 8 10:18:31.409 Creating index: { name: "files_id_1_n_1", key: { files_id: 1, n: 1 }, unique: true, ns: "test.img.chunks" }
Tue Sep 8 10:18:31.409 /tmp/test/fs.files.bson
Tue Sep 8 10:18:31.409 going into namespace [test.fs.files]
Tue Sep 8 10:18:31.410 warning: Restoring to test.fs.files without dropping. Restored data will be inserted without raising errors; check your server log
2 objects found
Tue Sep 8 10:18:31.410 Creating index: { name: "_id_", key: { _id: 1 }, ns: "test.fs.files" }
Tue Sep 8 10:18:31.410 /tmp/test/images.chunks.bson
Tue Sep 8 10:18:31.410 going into namespace [test.images.chunks]
Tue Sep 8 10:18:31.411 warning: Restoring to test.images.chunks without dropping. Restored data will be inserted without raising errors; check your server log
12 objects found
Tue Sep 8 10:18:31.414 Creating index: { name: "_id_", key: { _id: 1 }, ns: "test.images.chunks" }
Tue Sep 8 10:18:31.414 Creating index: { name: "files_id_1_n_1", key: { files_id: 1, n: 1 }, unique: true, ns: "test.images.chunks" }
Tue Sep 8 10:18:31.414 /tmp/test/images.files.bson
Tue Sep 8 10:18:31.414 going into namespace [test.images.files]
Tue Sep 8 10:18:31.414 warning: Restoring to test.images.files without dropping. Restored data will be inserted without raising errors; check your server log
3 objects found
Tue Sep 8 10:18:31.415 Creating index: { name: "_id_", key: { _id: 1 }, ns: "test.images.files" }
Tue Sep 8 10:18:31.415 /tmp/test/fs.chunks.bson
Tue Sep 8 10:18:31.415 going into namespace [test.fs.chunks]
Tue Sep 8 10:18:31.415 warning: Restoring to test.fs.chunks without dropping. Restored data will be inserted without raising errors; check your server log
2 objects found
Tue Sep 8 10:18:31.416 Creating index: { name: "_id_", key: { _id: 1 }, ns: "test.fs.chunks" }
Tue Sep 8 10:18:31.416 Creating index: { name: "files_id_1_n_1", key: { files_id: 1, n: 1 }, unique: true, ns: "test.fs.chunks" }
Tue Sep 8 10:18:31.416 /tmp/test/img.files.bson
Tue Sep 8 10:18:31.416 going into namespace [test.img.files]
Tue Sep 8 10:18:31.417 warning: Restoring to test.img.files without dropping. Restored data will be inserted without raising errors; check your server log
1 objects found
Tue Sep 8 10:18:31.417 Creating index: { name: "_id_", key: { _id: 1 }, ns: "test.img.files" }
Tue Sep 8 10:18:31.417 /tmp/test/bios.bson
Tue Sep 8 10:18:31.417 going into namespace [test.bios]
Tue Sep 8 10:18:31.417 warning: Restoring to test.bios without dropping. Restored data will be inserted without raising errors; check your server log
1 objects found
Tue Sep 8 10:18:31.417 Creating index: { key: { _id: 1 }, ns: "test.bios", name: "_id_" }

```

恢复到指定数据库

```

# mongorestore -h 127.0.0.1 -d test123 /tmp/test

```

### 远程回复

```

mongorestore --host mongodb.example.net --port 27017 --username backup --password password --db test --collection some /data/backup

```

### 本地恢复

```

mongorestore --dbpath /var/lib/mongodb --journal /opt/backu

```

### filter

如果只想恢复部分数据，可以使用--filter

```

$ mongorestore -h 127.0.0.1 -d test123 /tmp/test --filter '{"field": 1}'

```

## mongostat

```
			# mongostat
			connected to: 127.0.0.1
			insert query update delete getmore command flushes mapped vsize res faults locked db idx miss % qr|qw ar|aw netIn netOut conn time
			*0 *0 *0 *0 0 1|0 0 848m 1.92g 162m 0 wechat:0.0% 0 0|0 0|0 62b 4k 1 10:38:53
			*0 *0 *0 *0 0 1|0 0 848m 1.92g 162m 0 wechat:0.0% 0 0|0 0|0 62b 4k 1 10:38:54
			*0 *0 *0 *0 0 1|0 0 848m 1.92g 162m 0 wechat:0.0% 0 0|0 0|0 62b 4k 1 10:38:55
			*0 *0 *0 *0 0 1|0 0 848m 1.92g 162m 0 wechat:0.0% 0 0|0 0|0 62b 4k 1 10:38:56
			*0 *0 *0 *0 0 1|0 0 848m 1.92g 162m 0 wechat:0.0% 0 0|0 0|0 62b 4k 1 10:38:57

```

## mongotop

```
			# mongotop
			connected to: 127.0.0.1

			ns total read write 2015-09-08T02:23:46
			passport.system.users 0ms 0ms 0ms
			passport.system.namespaces 0ms 0ms 0ms
			passport.system.indexes 0ms 0ms 0ms
			member.system.users 0ms 0ms 0ms
			member.system.namespaces 0ms 0ms 0ms
			member.system.indexes 0ms 0ms 0ms

```

## mongofiles - Browse and modify a GridFS filesystem.

### list 浏览文件

```
				# mongofiles list
				connected to: 127.0.0.1
				/etc/passwd 2176
				/tmp/test1.php 192

```

### put 上传文件

```
				# mongofiles put /bin/ls
				connected to: 127.0.0.1
				added file: { _id: ObjectId('55ee4c68bd053b7418404c53'), filename: "/bin/ls", chunkSize: 261120, uploadDate: new Date(1441680488106), md5: "ca226dd605e91b72e0d2060a6357c28f", length: 109208 }
				done!

				# mongofiles list
				connected to: 127.0.0.1
				/etc/passwd 2176
				/tmp/test1.php 192
				/bin/ls 109208

```

上传指定数据库

```
				# mongofiles put -d images -c img /etc/fstab
				connected to: 127.0.0.1
				added file: { _id: ObjectId('55ee4d5416377f58d0a9e714'), filename: "/etc/fstab", chunkSize: 261120, uploadDate: new Date(1441680724579), md5: "381185dc0c4807b88406b452b4acc2e8", length: 1067 }
				done!

				# mongofiles list -d images -c img
				connected to: 127.0.0.1
				/etc/fstab 1067

```

### collection 参数有 bug 需要注意。

-c img 似乎无效，可能是 mongofiles 的 bug. 使用 PHP 测试上传是可以指定 collection，并且没有任何问题。

```

# mongofiles put -d images --collection abc /etc/nfsmount.conf
connected to: 127.0.0.1
added file: { _id: ObjectId('55ee4f5ef4b26bc3189dc8a5'), filename: "/etc/nfsmount.conf", chunkSize: 261120, uploadDate: new Date(1441681246083), md5: "ce3b9fee8612087cbb69d46db34ce8ec", length: 3605 }
done!

# mongofiles -d images --collection abc list
connected to: 127.0.0.1
/etc/fstab	1067
/etc/passwd	2555
/etc/goaccess.conf	6956
/etc/krb5.conf	449
/etc/nfsmount.conf	3605

# mongo images
> show collections;
abc.fs.chunks
abc.fs.files
fs.chunks
fs.files
system.indexes
>

> db.abc.fs.files.find();
>

```

使用 --collection 参数可以看到 abc 已经创建，但我们去 db.abc.fs.files.find();发现里面没有任何数据，文件仍然被上传到 abc.fs.files

### get 下载

如果 /tmp/test123 存在则会覆盖

```
				# mongofiles get /tmp/test123
				connected to: 127.0.0.1
				done write to: /tmp/test123

```

-l 指定路径，相当于另存。

```
				# mongofiles get /tmp/test123 -l /tmp/aabbcc
				connected to: 127.0.0.1
				done write to: /tmp/aabbcc

```

### delete 删除

```
				# mongofiles list
				connected to: 127.0.0.1
				/etc/passwd 2176
				/tmp/test1.php 192
				/bin/ls 109208
				/tmp/test123 6

				# mongofiles delete /tmp/test123
				connected to: 127.0.0.1
				done!

				# mongofiles list
				connected to: 127.0.0.1
				/etc/passwd 2176
				/tmp/test1.php 192
				/bin/ls 109208

```

## 第 45 章 MongoDB Shell

## shutdownServer

关闭 MongoDB 数据库

```

db.shutdownServer()

```

## show 查看命令

### show dbs

show dbs show database names

```

> show dbs
local	(empty)
logging	0.203125GB
test	0.203125GB

```

### show collections

show collections show collections in current database

```

> show collections
bios
system.indexes

```

另一种用法是 show tables

```

> show tables
bios
system.indexes

```

### show users

show users show users in current database

### show profile

show profile show most recent system.profile entries with time >= 1ms

```

> show profile
db.system.profile is empty
Use db.setProfilingLevel(2) will enable profiling
Use db.system.profile.find() to show raw profile entries

```

## 切换数据库

```

use <db name>                set curent database to <db name>

> use logging
switched to db logging

```

## save

存储嵌套的对象

```

db.foo.save({'name':'neo','address':{'city':'shenzhen','post':518000},'phone':[13113668890,13322993040]})

```

存储数组对象

```

db.foo.save({'Uid':'netkiller@msn.com','phone':['13322993040','13113668890']})

```

## insert

```

db.bios.insert(
   {
     _id: 1,
     name: { first: 'John', last: 'Backus' },
     birth: new Date('Dec 03, 1924'),
     death: new Date('Mar 17, 2007'),
     contribs: [ 'Fortran', 'ALGOL', 'Backus-Naur Form', 'FP' ],
     awards: [
               {
                 award: 'W.W. McDowell Award',
                 year: 1967,
                 by: 'IEEE Computer Society'
               },
               {
                 award: 'National Medal of Science',
                 year: 1975,
                 by: 'National Science Foundation'
               },
               {
                 award: 'Turing Award',
                 year: 1977,
                 by: 'ACM'
               },
               {
                 award: 'Draper Prize',
                 year: 1993,
                 by: 'National Academy of Engineering'
               }
             ]
   }
)

```

## update

根据 query 条件修改，如果不存在则插入，允许修改多条记录

```
			db.foo.update({'yy':5},{'$set':{'xx':2}},upsert=true,multi=true)

```

### multi 更新所有数据

update 第一个参数是条件，当不写条件时将匹配所有数据。

```

db.getCollection('certificate').update({},{'$set':{'icon':'52bfbb7d92b3f41da2e4103f1990c054990be863.png'}},upsert=false,multi=true)			

```

### upsert 更新，如果不存在则插入数据

```

db.getCollection('shippingAddress').update({'memberId':'00000000'},{'$set':{'defaults': false}},upsert=true,multi=true)

```

## remove

删除 uid=10 的记录

```

db.foo.remove({'uid':10})

```

删除所有的记录

```
			db.foo.remove()

```

### 删除条件使用 _id

```
				db.foo.remove({ "_id" : ObjectId("56e10b66a22ef1b1408b4567")})
				db.getCollection('goods').remove({ "_id": ObjectId("5bbdbd197099aa06abf6fb1a")})

```

## 删除 collection

```
			db.collection.drop()

```

### 删除字段

```

db.getCollection('table').update({},{$unset:{field:1}})			

```

## count()

```

> db.access.count()
51528
> db.access.count()
104401

```

## 查询

### find() MongoDB 2.x

查找所有 所有记录

```
			db.foo.find() list objects in collection foo
			db.foo.find( { a : 1 } ) list objects in foo where a == 1

```

查找一条记录

```
			db.foo.findOne()

```

根据条件检索 10 条记录

```
			db.foo.find({'name':'neo'}).limit(10)

```

sort 排序

```
			db.foo.find({'name':'neo'}).sort({'Dt',-1})
			db.foo.find().sort({'Ct':-1}).limit(1)

```

count 记录统计操作

```
			db.foo.count()

```

distinct 操作,去重复查询指定列，

```
			db.foo.distinct('name')

```

”>=”操作

```

db.foo.find({"timestamp": {"$gte" : 2}})

```

子对象的查找

```
			db.foo.find({'address.city':'shenzhen'})

```

### find() MongoDB 3.x

```
			db.getCollection('tracker').find({name:"81004892"})

```

#### Query

#### 包含字段

```

db.getCollection('pyramidSelling').find({},{'phone':1})			

```

#### 排除字段

```
				db.getCollection('pyramidSelling').find({},{'phone':0})

```

#### sort()

```
				db.getCollection('tracker').find({name:"81004892"}).sort({ctime: -1})

```

### group()

group()类似 SQL 中的 Group by

```

> db.test.group({key: {remote_addr: true}, initial: {count: 0}, reduce: function(obj, prev) {prev.count++}});
[
	{
		"remote_addr" : "192.168.2.76",
		"count" : 3
	},
	{
		"remote_addr" : "192.168.2.70",
		"count" : 1
	}
]

```

## aggregate

### project

#### $split

```
					{
					"_id" : ObjectId("591a710320156761bdf68a06"),
					"_class" : "mis.domain.PyramidSelling",

					...
					...

					"status" : true,
					"createdDate" : ISODate("2017-05-16T03:24:51.511Z")
					}

```

```

db.getCollection('pyramidSelling').aggregate([
  { $project : { _class : { $split: ["$_class", "."] } } }
]);			

```

#### substr

```
					db.getCollection('pyramidSelling').aggregate(
					[
					{
					$project: {
					userName: 1,
					phone: {
					prefix: { $substr: [ "$phone", 0, 3 ] },
					mobile: { $substr: [ "$phone", 3, 11 ] }
					},
					}
					}
					]
					)

```

### groupby + sum

select username, sum(balance) as total from users group by member.

```

db.member.aggregate([{ 
    $group: { 
        _id: "$username", 
        total: { $sum: "$balance" }
    } 
}])

```

## Indexes 索引

增加索引：1(ascending),-1(descending)

### 查看索引

```

db.getCollection('product').getIndexes() 		

```

```

[
    {
        "v" : 2,
        "key" : {
            "_id" : 1
        },
        "name" : "_id_",
        "ns" : "netkiller.product"
    },
    {
        "v" : 2,
        "unique" : true,
        "key" : {
            "uuid" : 1
        },
        "name" : "uuid",
        "ns" : "netkiller.product",
        "sparse" : true
    },
    {
        "v" : 2,
        "key" : {
            "nfc" : 1
        },
        "name" : "nfc",
        "ns" : "netkiller.product"
    },
    {
        "v" : 2,
        "unique" : true,
        "key" : {
            "qrcode" : 1
        },
        "name" : "qrcode",
        "ns" : "netkiller.product",
        "sparse" : true
    },
    {
        "v" : 2,
        "key" : {
            "memberId" : 1
        },
        "name" : "memberId",
        "ns" : "netkiller.product"
    },
    {
        "v" : 2,
        "unique" : true,
        "key" : {
            "transactionId" : 1
        },
        "name" : "transactionId",
        "ns" : "netkiller.product",
        "sparse" : true
    }
]		

```

查看索引信息

```

db.logging.getIndexes()
[
	{
		"v" : 1,
		"key" : {
			"_id" : 1
		},
		"ns" : "logging.logging",
		"name" : "_id_"
	}
]		

```

查看索引名与排序方式

```

db.getCollection('member').getIndexKeys();

[
    {
        "_id" : 1
    },
    {
        "mobile" : 1
    },
    {
        "username" : 1
    },
    {
        "wechat" : 1
    }
]

```

### 创建索引

增加索引

```

db.foo.ensureIndex({firstname: 1, lastname: 1}, {unique: true});		

```

索引子对象

```

db.logging.users.ensureIndex({address.city:1})

```

### 删除索引

```

db.getCollection('product').dropIndex("memberId")		

```

根据索引名删除索引

```

> db.logging.users.dropIndex('name_1')
{ "nIndexesWas" : 2, "ok" : 1 }

> db.logging.users.getIndexKeys()
[ { "_id" : 1 } ]

```

### 唯一索引

```

db.members.createIndex( { "user_id": 1 }, { unique: true } )		

```

```

> db.apple.createIndex({"devicetoken":1},{unique: true})
{
	"createdCollectionAutomatically" : false,
	"numIndexesBefore" : 1,
	"numIndexesAfter" : 2,
	"ok" : 1
}

```

### 复合索引

```

db.getCollection('foo').ensureIndex({"address":1,"phone":1})		

```

### 稀疏索引

```

db.getCollection('article').ensureIndex({"uuid": 1}, {"unique": true,"sparse":true});

```

作用, 唯一索引只允许一条索引字段为空的记录存在，之后就不允许插入了。再次插入为 null 的记录时会报错：

```

E11000 duplicate key error index: dup key: { : null };	

```

“sparse”的作用就是当 uuid 在文档中不存在，或为空值，则不进入索引，从而避免上述问题。

## Map-Reduce

### 使用 Map-Reduce 统计 Web 服务器 access.log 日志文件

首先将 web 服务器 access.log 导入到 mongodb,参考 http://netkiller.github.io/article/log.html 格式如下：

```
{
	"_id" : ObjectId("51553efcd8616be7e5395c0d"),
	"remote_addr" : "192.168.2.76",
	"remote_user" : "-",
	"time_local" : "29/Mar/2013:09:20:31 +0800",
	"request" : "GET /tw/ad.jpg HTTP/1.1",
	"status" : "200",
	"body_bytes_sent" : "5557",
	"http_referer" : "http://www.example.com/tw/",
	"http_user_agent" : "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.17 (KHTML, like Gecko) Chrome/24.0.1312.57 Safari/537.17",
	"http_x_forwarded_for" : "-"
}

```

创建 map 方法

```
var mapFunction1 = function() {
    emit(this.remote_addr, {count:1});
};

```

创建 reduce 方法

```

var reduceFunction1 = function(key, values) {
	var total = 0;
	values.forEach(function (value) {total += value.count;});
    return {ipaddr: key, count:total};
};

```

分析数据

```
db.access.mapReduce(mapFunction1, reduceFunction1, {out : "resultCollection"});

```

输出结果

```
db.resultCollection.find();

```

Demo 数据库

```

> db.resultCollection.find();
{ "_id" : "192.168.2.109", "value" : { "ipaddr" : "192.168.2.109", "count" : 554 } }
{ "_id" : "192.168.2.38", "value" : { "ipaddr" : "192.168.2.38", "count" : 26 } }
{ "_id" : "192.168.2.39", "value" : { "ipaddr" : "192.168.2.39", "count" : 72 } }
{ "_id" : "192.168.2.40", "value" : { "ipaddr" : "192.168.2.40", "count" : 3564 } }
{ "_id" : "192.168.2.49", "value" : { "ipaddr" : "192.168.2.49", "count" : 955 } }
{ "_id" : "192.168.2.5", "value" : { "ipaddr" : "192.168.2.5", "count" : 2 } }
{ "_id" : "192.168.2.76", "value" : { "ipaddr" : "192.168.2.76", "count" : 60537 } }
{ "_id" : "192.168.3.12", "value" : { "ipaddr" : "192.168.3.12", "count" : 9577 } }
{ "_id" : "192.168.3.14", "value" : { "ipaddr" : "192.168.3.14", "count" : 343 } }
{ "_id" : "192.168.3.18", "value" : { "ipaddr" : "192.168.3.18", "count" : 1006 } }
{ "_id" : "192.168.3.26", "value" : { "ipaddr" : "192.168.3.26", "count" : 2714 } }
{ "_id" : "192.168.6.19", "value" : { "ipaddr" : "192.168.6.19", "count" : 668 } }
{ "_id" : "192.168.6.2", "value" : { "ipaddr" : "192.168.6.2", "count" : 123760 } }
{ "_id" : "192.168.6.30", "value" : { "ipaddr" : "192.168.6.30", "count" : 1196 } }
{ "_id" : "192.168.6.35", "value" : { "ipaddr" : "192.168.6.35", "count" : 1050 } }
>

```

## 内嵌对象

### Array / List 列表类型

```

db.foo.save(
{
	'name':'neo',
	'address':[{'city':'shenzhen','post':"518000"}, {'city':'heilongjiang','post':"135000"}],
	'phone':["13113668800","13322993040","13266884444"]
}
)

```

```

{
    "_id" : ObjectId("5bbefed1b04a8c0d7395d1b5"),
    "name" : "neo",
    "address" : [ 
        {
            "city" : "shenzhen",
            "post" : "518000"
        }, 
        {
            "city" : "heilongjiang",
            "post" : "135000"
        }
    ],
    "phone" : [ 
        "13113668800", 
        "13322993040", 
        "13266884444"
    ]
}	

```

删除数组元素

```

db.getCollection('foo').update({"_id":ObjectId("5bbeff40b04a8c0d7395d1b6")},{"$pull":{"phone":"13266884444"}})		

```

删除数组中的对象

```

db.getCollection('foo').update({"_id":ObjectId("5bbeff40b04a8c0d7395d1b6")},{"$pull":{"address":{"city":"heilongjiang"}}})

```

查找替换

```

db.getCollection('foo').update({"address.city":"shenzhen"},{"$set":{"address.$.post":"000000"}})			

```

## Javascript 脚本

```

db.numbers.drop()

var counter = 0
while (counter<=1000){
  db.numbers.save({"value":counter})
  counter = counter + 1;
}

```

## 第 46 章 Mongo Admin UI

http://docs.mongodb.org/ecosystem/tools/administration-interfaces/

## RockMongo

[`code.google.com/p/rock-php/`](http://code.google.com/p/rock-php/)

## MongoVUE

http://blog.mongovue.com/

MongoVUE 是收费软件，提供的功能比较完善，可以免费试用

## 第 47 章 FAQ

## Reset root password 重置 MySQL root 密码

忘记 root 密码是使用 --skip-grant-tables 启动项

CentOS 6.x

```

# vim /etc/init.d/mysqld

 $exec --skip-grant-tables  --datadir="$datadir" --socket="$socketfile" \
    --pid-file="$mypidfile" \
    --basedir=/usr --user=mysql >/dev/null 2>&1 &

```

```

# /etc/init.d/mysqld restart
Stopping mysqld:                                           [  OK  ]
Starting mysqld:                                           [  OK  ]

# mysqladmin -u root flush-privileges password "newpassword"

```

### MySQL 5.7.x

CentOS 7.x

添加 skip-grant-tables=1 选项，然后重启 mysql

```

# cat /etc/my.cnf
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.6/en/server-configuration-defaults.html

[mysqld]
#
# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M
#
# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
# log_bin
#
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M
datadir=/var/lib/mysql
socket=/var/lib/mysql/mysql.sock
skip-grant-tables=1
# Disabling symbolic-links is recommended to prevent assorted security risks
symbolic-links=0

# Recommended in standard MySQL setup
sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES 

[mysqld_safe]
log-error=/var/log/mysqld.log
pid-file=/var/run/mysqld/mysqld.pid

```

```

# systemctl restart mysqld

```

```

update mysql.user set authentication_string=password('netkiller') where user='root' and Host = 'localhost';
flush privileges;
quit;

```

```

# mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 2
Server version: 5.7.14 MySQL Community Server (GPL)

Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> update mysql.user set authentication_string=password('netkiller') where user='root' and Host = 'localhost';
Query OK, 1 row affected, 1 warning (0.03 sec)
Rows matched: 1  Changed: 1  Warnings: 1

mysql> flush privileges;
Query OK, 0 rows affected (0.00 sec)

mysql> quit;
Bye

```

删除 skip-grant-tables=1 重启 MySQL

### MySQL 8.0

```

[root@localhost log]# vim /etc/my.cnf

[mysqld]
skip-grant-table

```

```

ALTER USER root@localhost identified by 'MQiEge1ikst7S_6tlXzBOmt';
ALTER USER root@localhost PASSWORD EXPIRE NEVER;			

```

## 数据库内容替换

```

#!/bin/bash
HOST='localhost'
USER='neo'
PASS='chen'

SDB='neo'
TDB='netkiller'
MYSQLDUMP="mysqldump"
MYSQLDUMPOPTS="-h${HOST} -u${USER} -p${PASS}"

MYSQL="mysql"
MYSQLOPTS="-h${HOST} -u${USER} -p${PASS}"
#SED="sed -e 's/netkiller\.8800\.org/netkiller\.sf\.net/g' -e 's/陈景峰/景峰/g' -e 's/Neo/Netkiller/g'"

$MYSQL $MYSQLOPTS <<SQL
DROP DATABASE $TDB;
CREATE DATABASE $TDB DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
SQL

$MYSQLDUMP $MYSQLDUMPOPTS ${SDB} | sed -e 's/netkiller\.8800\.org/netkiller\.sf\.net/g' -e 's/陈景峰/景峰/g' -e 's/Neo/Netkiller/g' | $MYSQL $MYSQLOPTS ${TDB}
#echo "$MYSQLDUMP $MYSQLDUMPOPTS ${SDB} | $SED | $MYSQL $MYSQLOPTS ${TDB}"

```

## 查看错误代码

```

mysql> \! perror 6
OS error code   6:  No such device or address

```

### ERROR 1153 (08S01) at line 3168: Got a packet bigger than 'max_allowed_packet' bytes

```
max_allowed_packet=500M

```

### ERROR 1129 (00000): Host 'XXXXXX' is blocked because of many connection errors; unblock with 'mysqladmin flush-hosts'

连接在中途被中断了的连接请求。在 max_connect_errors 次失败请求后，mysql 阻止该主机进一步的连接，直到管理员执行命令 mysqladmin flush-hosts。

```

mysql> flush hosts;

```

```
set global max_connect_errors=1000;

```

```
max_connect_errors=10000

```

## 临时表是否需要建索引

答案：要

## Kill 脚本

查询出锁定的表

SELECT concat('KILL ',id,';') FROM information_schema.processlist WHERE user='root';

SELECT concat('KILL ',id,';') FROM information_schema.processlist WHERE command='Locked' and user='root';

SELECT concat('KILL ',id,';') FROM information_schema.processlist WHERE command='Locked' and user='root' and db='test';

拼装 kill 命令后输入到 kill.sql, source 将从 kill.sql 读取 sql 命令并执行。

```
SELECT concat('KILL ',id,';') FROM information_schema.processlist WHERE user='root' INTO OUTFILE '/tmp/kill.sql';

source /tmp/kill.sql;

```

```
mysqladmin -uroot -p processlist | grep Sleep |awk '{if (length($2) > 1) print "Kill "$2}'|xargs mysqladmin -uroot kill

```

## ERROR 1503 (HY000): A PRIMARY KEY must include all columns in the table's partitioning function

[`dev.mysql.com/doc/refman/5.1/en/partitioning-limitations-partitioning-keys-unique-keys.html`](http://dev.mysql.com/doc/refman/5.1/en/partitioning-limitations-partitioning-keys-unique-keys.html)

## ERROR 1820 (HY000): You must reset your password using ALTER USER statement before executing this statement.

这个错误来自 MySQL 5.7，首次登陆 MySQL 5.7 必须修改密码

```
ALTER USER 'root'@'localhost' IDENTIFIED BY 'your_password';		

```

## ERROR 1819 (HY000): Your password does not satisfy the current policy requirements

MySQL 5.7 密码强度，必须含有 0-9，a-z,A-Z 以及“-”或“_”

https://dev.mysql.com/doc/refman/5.7/en/validate-password-options-variables.html

禁用密码安全策略（早起 5.7 版本可用，新版已经废弃这个选项）

```
#  cat /etc/my.cnf | grep validate-password
validate-password=OFF

```

新的方式修改策略与密码长度

```

mysql> set global validate_password_policy=0;
mysql> set global validate_password_length=4;
mysql> grant all privileges on test.* to 'test'@localhost  identified by 'chen';

```

## 重新整理 AUTO_INCREMENT 字段

AUTO_INCREMENT 并非按照我们意愿，顺序排列，经常会跳过一些数字，例如当插入失败的时候，再次插入会使用新的值。有时会造成浪费，我们可以使用下面 SQL 重新编排 AUTO_INCREMENT 序列。

```
SET @newid=0;
UPDATE mytable SET id = (SELECT @newid:=@newid+ 1);

```

使用 max()查看最大值，然后使用 alter 修改起始位置。

```
select max(id) from mytable;
ALTER TABLE mytable AUTO_INCREMENT = 1000;		

```

注意外键，需要 ON UPDATE CASCADE 支持，否则无法更新。CONSTRAINT `FK_group_has_contact_contact` FOREIGN KEY (`contact_id`) REFERENCES `contact` (`id`) ON UPDATE CASCADE ON DELETE CASCADE,

```
CREATE TABLE `contact` (
	`id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '唯一 ID',
	`name` VARCHAR(50) NOT NULL COMMENT '姓名',
	`mobile` VARBINARY(32) NULL DEFAULT NULL COMMENT '手机号码',
	`email` VARBINARY(50) NULL DEFAULT NULL COMMENT '电子邮件',
	`mobile_digest` VARCHAR(32) NULL DEFAULT NULL COMMENT '摘要',
	`email_digest` VARCHAR(32) NULL DEFAULT NULL COMMENT '邮件摘要',
	`birthday` DATE NULL DEFAULT NULL COMMENT '生日',
	`description` VARCHAR(255) NULL DEFAULT NULL COMMENT '备注描述',
	`status` ENUM('Subscription','Unsubscribe') NOT NULL DEFAULT 'Subscription' COMMENT '订阅状态',
	`ctime` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
	`mtime` TIMESTAMP NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
	PRIMARY KEY (`id`),
	UNIQUE INDEX `digest` (`mobile_digest`, `email_digest`)
)
COMMENT='会员手机短信与电子邮件映射表'
COLLATE='utf8_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=43642;

CREATE TABLE `group` (
	`id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
	`name` VARCHAR(50) NOT NULL,
	`description` VARCHAR(512) NOT NULL,
	`ctime` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (`id`),
	UNIQUE INDEX `name` (`name`)
)
COMMENT='短信分组'
COLLATE='utf8_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=8;

CREATE TABLE `group_has_contact` (
	`id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
	`group_id` INT(10) UNSIGNED NOT NULL,
	`contact_id` INT(10) UNSIGNED NOT NULL,
	`ctime` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	PRIMARY KEY (`id`),
	UNIQUE INDEX `group_contact` (`group_id`, `contact_id`),
	INDEX `FK_group_has_contact_contact` (`contact_id`),
	CONSTRAINT `FK_group_has_contact_contact` FOREIGN KEY (`contact_id`) REFERENCES `contact` (`id`) ON UPDATE CASCADE ON DELETE CASCADE,
	CONSTRAINT `FK_group_has_contact_group` FOREIGN KEY (`group_id`) REFERENCES `group` (`id`) ON UPDATE CASCADE ON DELETE CASCADE
)
COMMENT='N:M'
COLLATE='utf8_general_ci'
ENGINE=InnoDB
AUTO_INCREMENT=55764;

```

## 转换 latin1 到 UTF-8

```
UPDATE category SET 
    name=convert(cast(convert(name using  latin1) as binary) using utf8),
    description=convert(cast(convert(description using  latin1) as binary) using utf8)

```

## this is incompatible with sql_mode=only_full_group_by

ERROR 1055 (42000): Expression #1 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'mydb.contact.id' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by

```

mysql> select @@version;
+-----------+
| @@version |
+-----------+
| 5.7.10    |
+-----------+
1 row in set (0.00 sec)

mysql> select @@GLOBAL.sql_mode;
+-------------------------------------------------------------------------------------------------------------------------------------------+
| @@GLOBAL.sql_mode                                                                                                                         |
+-------------------------------------------------------------------------------------------------------------------------------------------+
| ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |
+-------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

mysql> SET sql_mode = '';
Query OK, 0 rows affected, 1 warning (0.00 sec)

mysql> select id,name from contact group by name limit 10;
+-------+-------------+
| id    | name        |
+-------+-------------+
| 84046 |   张伟      |
| 80259 |   张磊      |
|   784 |   王岩      |
| 87685 |  杨钞       |
+-------+-------------+
10 rows in set (0.07 sec)

```

不建议设置 SET sql_mode = ''，正确方式如下：

```

mysql> set global sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
mysql> set session sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';		

```

或者采用

```

Adding only one mode to sql_mode without removing existing ones:

SET sql_mode=(SELECT CONCAT(@@sql_mode,',<mode_to_add>'));
Removing only a specific mode from sql_mode without removing others:

SET sql_mode=(SELECT REPLACE(@@sql_mode,'<mode_to_remove>',''));
In your case, if you want to remove only ONLY_FULL_GROUP_BY mode, then use below command:

SET sql_mode=(SELECT REPLACE(@@sql_mode, 'ONLY_FULL_GROUP_BY', ''));		

```

## [Warning] Changed limits: max_open_files: 5000 (requested 20480)

```

2018-01-08T01:34:44.515973Z 0 [Warning] Changed limits: max_open_files: 5000 (requested 10240)
2018-01-08T01:34:44.516402Z 0 [Warning] Changed limits: table_open_cache: 1471 (requested 2000)		

```

提出出现在 CentOS 7 ulimit 配置没有问题的情况下 mysql 日志提示 Warning

```
# ulimit -Sa | grep "open files"
open files                      (-n) 40960		

```

```
[root@netkiller ~]# cat /proc/`pidof mysqld`/limits
Limit                     Soft Limit           Hard Limit           Units     
Max cpu time              unlimited            unlimited            seconds   
Max file size             unlimited            unlimited            bytes     
Max data size             unlimited            unlimited            bytes     
Max stack size            8388608              unlimited            bytes     
Max core file size        0                    unlimited            bytes     
Max resident set          unlimited            unlimited            bytes     
Max processes             63494                63494                processes 
Max open files            5000                 5000                 files     
Max locked memory         65536                65536                bytes     
Max address space         unlimited            unlimited            bytes     
Max file locks            unlimited            unlimited            locks     
Max pending signals       63494                63494                signals   
Max msgqueue size         819200               819200               bytes     
Max nice priority         0                    0                    
Max realtime priority     0                    0                    
Max realtime timeout      unlimited            unlimited            us        

```

动态改变

```
[root@netkiller ~]# egrep '^(Limit|Max open files)' /proc/`pidof mysqld`/limits
Limit                     Soft Limit           Hard Limit           Units     
Max open files            5000                 5000                 files  

```

问题的出现出现原因是 systemctl 启动脚本覆盖了 ulimit 配置

```
# cat /usr/lib/systemd/system/mysqld.service | grep -A2 open_files_limit
# Sets open_files_limit
LimitNOFILE = 5000

```

解决方法，直接修改上面的数值，不建议修改 mysqld.service，这样会影响你下次升级。请采用下面的方案完美解决：

```

mkdir /usr/lib/systemd/system/mysqld.service.d

cat >> /usr/lib/systemd/system/mysqld.service.d/override.conf <<EOF
[Service]
LimitNOFILE=40960
EOF

```

重启 MySQL

```
systemctl daemon-reload
systemctl restart mysqld

```

检查是否生效

```

mysql> show variables like 'open_files_limit';
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| open_files_limit | 65535 |
+------------------+-------+
1 row in set (0.01 sec)		

```

## ERROR 1364: 1364: Field 'id' doesn't have a default value

```

set @@SESSION.sql_mode='NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
SELECT @@GLOBAL.sql_mode;
UPDATE `cms`.`content` SET `source`='test' WHERE `content_id`='1099';		

```

## ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement

MySQL 不允许向 secure_file_priv 意外的目录导出文件。

```

mysql> SELECT * FROM `order` INTO OUTFILE '/tmp/order.txt';
ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement

mysql> show variables like '%secure%';
+--------------------------+-----------------------+
| Variable_name            | Value                 |
+--------------------------+-----------------------+
| require_secure_transport | OFF                   |
| secure_auth              | ON                    |
| secure_file_priv         | /var/lib/mysql-files/ |
+--------------------------+-----------------------+
3 rows in set (0.00 sec)

mysql> SELECT * FROM `order` INTO OUTFILE '/var/lib/mysql-files/order.txt';
Query OK, 3 rows affected (0.00 sec)

root@netkiller ~ % cat /var/lib/mysql-files/order.txt
1	Tom	22	2017-11-16 17:23:15
2	Neo	34.65	2017-11-16 17:29:28
3	Cici	34.98	2017-11-16 17:30:29

```

在 my.cnf 中 加入 secure-file-priv=/tmp 可以修改为你需要的目录。

## ERROR 1086 (HY000): File '/var/lib/mysql-files/order.txt' already exists

SELECT * FROM tabname INTO OUTFILE 不支持覆盖操作，这是 MySQL 从安全角度考虑的。

```

mysql> SELECT * FROM `order` INTO OUTFILE '/var/lib/mysql-files/order.txt';
ERROR 1086 (HY000): File '/var/lib/mysql-files/order.txt' already exists		

```

## ERROR 1415: Not allowed to return a result set from a trigger

触发器中不允许返回结果集，解决方法是顶一个变量，然后将返回值返回给变量。

```

DROP TRIGGER IF EXISTS `test`.`demo_AFTER_INSERT`;

DELIMITER $$
USE `test`$$
CREATE DEFINER=`root`@`%` TRIGGER `test`.`demo_AFTER_INSERT` AFTER INSERT ON `demo` FOR EACH ROW
BEGIN
	set @rev = "";
	SELECT 
    OUT2FILE('/tmp/demo.log',
            CONCAT_WS(',',
                    NEW.id,
                    NEW.name,
                    NEW.sex,
                    NEW.address))
	INTO @rev;
END$$
DELIMITER ;		

```

## Authentication plugin 'caching_sha2_password' cannot be loaded: /usr/lib64/mysql/plugin/caching_sha2_password.so: cannot open shared object file: No such fileor directory

这个故障出现在 MySQL 8.0 上，用户使用 mysql client 5.7 链接 MySQL 8.0 提示如下

```

[root@netkiller ~]# mysql -h 193.112.95.53 -uroot -p
Enter password:
ERROR 2059 (HY000): Authentication plugin 'caching_sha2_password' cannot be loaded: /usr/lib64/mysql/plugin/caching_sha2_password.so: cannot open shared object file: No such fileor directory

```

解决方案，创建用户使用 mysql_native_password 密码

```

mysql> CREATE USER 'root'@'%' IDENTIFIED WITH mysql_native_password BY 'pMQiEge1ikst7S_6tlXzBOmt_4b';
Query OK, 0 rows affected (0.08 sec)

mysql> grant all on *.* to 'root'@'%';
Query OK, 0 rows affected (0.08 sec)

```

重新链接

```

[root@netkiller ~]# mysql -h 193.112.95.53 -uneo -p
Enter password:
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 24
Server version: 8.0.11 MySQL Community Server - GPL

Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql>

```

## com.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: Public Key Retrieval is not allowed

问题出在现在 MySQL 8.0 版本

解决方法：在连接后面添加 allowPublicKeyRetrieval=true

```

spring.datasource.url=jdbc:mysql://192.168.0.1:3306/test?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true

```