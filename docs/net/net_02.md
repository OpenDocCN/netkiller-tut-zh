# 第 1 章 IDC

## 接入线路

### 带宽计算

### 双线/多线

#### 智能 DNS (Smart DNS)

### BGP

### 接入线路测试

用于评估机房线路.

ping.lst

```
202.96.134.133
202.96.128.68
...
...

```

测试脚本

```

#!/bin/bash
for addr in `cat ping.lst`
do
        ping -c 5 -s 128 -W 5 $addr
        echo
        echo
done > ping_report.txt &

```

将不同机房的出 ping_report.txt 文件汇总，然后用是 diff 对比。例如 vimdiff report1.txt report2.txt.

```

#!/bin/bash
for addr in `cat ping.lst`
do
        traceroute $addr
        echo
        echo
done > traceroute_report.txt &

```

## 机柜(Cabinets)

目前比较新的五星级机房，前门都是全铁门，后门是网面双开门，老 IDC 很多是玻璃门。空调系统是机柜摆放背对背，然后从前门地下向上送风，后门过道抽走热风。

机柜前面放入服务器，每个服务器一个隔板，服务器之间要有 1U 的空间，便于空气流通。

打开机柜后门，左侧是网线槽，右侧是强电槽

| ![](img/cabinets.png) |

### 强电相关

一般情况是每个机柜分配 15A（安培）的电力供应，也有一些 IDC 是规定 13A。据说花钱可以增加。

右侧壁上会提供 10 组 20 个电源插座; 每个插孔均配有空气开关，这样可以防止单个服务器短路，导致整个机柜掉电。

一般 42U 的机柜最多能够放置 15 台 1U 服务器加一个交换机。有些企业被忽悠买了刀片服务器，发现一个机柜只能放置一个刀笼（因为电力不够，只能提供 15 安培）。

### IP 分配

每个机柜一般只能放 15 台服务器，可以给每个机柜分配 20 或 40 个 IP 地址

### 服务器与设备命令

下面是我常用的命令规则

```

坐标命令法：
<X>-<Y>-<Z>
<水平>-<垂直>-<巷位>
例如: 5-4-1

<机柜>-<IP>-<功能>

```

## 服务器部署与网络拓扑

所谓大型网站主要的特点是访问量大，既海量访问，对带宽要求大，而在中国的网络环境比较复杂，单单靠一家也难保访问的快速、稳定，我们可能选择多家网络运营商，才能得到保障。

我们不得不把服务器分散部署到各地

### 小型网站

一个 IP，多台服务器流水线方式解决方案。

![](img/line.png)

这种方案必须使用带有双网卡的服务器，建议选择千兆网卡，web 服务器与 database 连接建议采用交叉线互联，不要通过 Hub,Switch 连接。

当 web 和 database 在同一台服务器是建议采用 UNIX SOCK 来链接数据库，以代替 TCP/IP Socket。

以上图中的第三套方案为例，当用户访问网站时，通过电信交换机连接到 cache 服务器，有两种情况。第一种是静态 html 文件或图片，将判断是否被缓存，如果缓存直接反馈给用户否则链接 web 服务器。第二种动态脚本，将处理立即送给 web 服务器。如果动态脚本有请求数据库操作，将连接 database 服务器。

这种方式适合中小型企业，非互联网运营商，仅仅是用一个 IP 实现。

两个 IP，多台服务器解决方案。

![](img/twoip.png)

建议你吧图片，缩图单独使用一台服务器实现。

多个 IP，多台服务器解决方案。

![](img/threeip.png)

这种方案要注意服务器全部暴露在 WAN 上，一定要谨慎设置 iptables 规则。

### 集群网站

![](img/cluster.png)

下面是负载均衡的例子

过程 1.1. 过程访问演示

1.  访问用户 www.example.com 网站

    用户输入网址: www.example.com 回车

2.  dns

    域名服务器将 www.example.com 解析到 load balancing 负载请均衡调度服务器。

3.  load balancing

    负载均衡器根据调度算法分配到某个 squid 节点上

4.  squid

    静态规则：判段是否是缓存，如果已经缓存从 cache 中直接取出内容，否则请求 web 服务器

    动态规则：直接请求 web 服务器

    请求 web 服务器是将再次由 load balancing 分配 web 节点

5.  web

    web server 处理动态脚本，连接数据库查询。连接数据库是仍然需要由 load balancing 分配 database 节点

6.  database

    database cluster

### 关于服务器远程管理

将每一台服务器暴露在广域网上不是一个好主意，我的经验是，目前服务器基本都是双网卡。

eth0: 用于对外访问，如 web 服务器仅仅开放 80 端口，其他端口不允许在广域网上直接访问。

eth1: 对内有一个私有局域网，开放 SSH 的 22 端口。22 端口仅仅能通过私有局域网访问，不能通过广域网访问。

在机房放置一台专门的管理服务器并安装有 VPN 服务，当远程管理服务器是通过 VPN 连接到这台服务器，登录到这台服务器上，然后在通过 SSH 登录到私有 LAN 上的其他服务器进行远程管理。

下面是 VPN 解决方案图

![](img/vpn.png)

## DDOS 攻击与流量清洗

## RALDRS

remote application layer disaster recovery system(RALDRS)